<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Admin</title>
  <link rel="stylesheet" href="/css/admin/order-details.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

<div class="container">
  <!-- Header -->
  <div class="header">
    <div>
      <h1>Order Item Detail — #<%= order.orderId %></h1>
      <p>Item <%= itemIndex + 1 %> of <%= order.products.length %> • Placed on <%= new Date(order.createdAt).toLocaleDateString('en-GB') %></p>
    </div>
    <a href="/admin/orders" class="btn-back">← Back to Orders List</a>
  </div>

  <!-- Main Layout: Product Left, Info Right -->
  <div class="grid">
    <!-- Left: Product -->
    <div class="product-card">
      <img src="<%= item.variantId?.images?.[0] || item.productId?.images?.[0] || '/images/no-image.jpg' %>" 
           alt="<%= item.productId.name %>" 
           class="product-img">

      <h2><%= item.productId.name %></h2>

      <div class="variant-tags">
        <% if (item.variantId?.colorName) { %>
          <span class="variant-tag">Color: <%= item.variantId.colorName %></span>
        <% } %>
        <% if (item.variantId?.size) { %>
          <span class="variant-tag">Size: <%= item.variantId.size %></span>
        <% } %>
      </div>

      <div class="pricing">
        <p>Unit Price: <strong>₹<%= item.price.toLocaleString('en-IN') %></strong></p>
        <p>Quantity: <strong><%= item.quantity %></strong></p>
        <p class="subtotal">Subtotal: <strong>₹<%= (item.price * item.quantity).toLocaleString('en-IN') %></strong></p>
      </div>

      <% if (item.reason) { %>
        <div class="reason-box">
          <strong>Cancellation/Return Reason:</strong> <%= item.reason %>
        </div>
      <% } %>
    </div>

    <!-- Right: Customer & Order Info -->
    <div class="info-section">
      <div class="info-card">
        <h3>Customer Information</h3>
        <p><strong><%= order.userId.name %></strong></p>
        <p><%= order.userId.email %></p>
        <p><%= order.userId.phone || 'N/A' %></p>
      </div>

      <div class="info-card">
        <h3>Shipping Address</h3>
        <p><strong><%= order.address.fullName %></strong></p>
        <p><%= order.address.address1 %></p>
        <% if (order.address.address2) { %><p><%= order.address.address2 %></p><% } %>
        <p><%= order.address.city %>, <%= order.address.state %> - <%= order.address.pincode %></p>
        <p><%= order.address.country %></p>
      </div>

      <div class="info-card">
        <h3>Order & Payment</h3>
        <p>Total Amount: <strong>₹<%= order.totalAmount.toLocaleString('en-IN') %></strong></p>
        <p>Payment Method: <strong><%= order.paymentMethod.toUpperCase() %></strong></p>
        <p>Payment Status: 
          <span class="payment-badge <%= order.paymentStatus === 'Paid' ? 'paid' : 'pending' %>">
            <%= order.paymentStatus.toUpperCase() %>
          </span>
        </p>
      </div>
    </div>
  </div>

  <!-- Admin Actions -->
  <div class="actions-card">
    <h3>Admin Actions — This Item Only</h3>

    <div class="current-status <%= item.itemStatus.toLowerCase().replace(/ /g, '-') %>">
      <%= 
        item.itemStatus === 'ReturnRequested' ? 'RETURN REQUESTED' :
        item.itemStatus === 'ReturnApproved' ? 'RETURN APPROVED' :
        item.itemStatus === 'Out for Delivery' ? 'OUT FOR DELIVERY' :
        item.itemStatus.toUpperCase()
      %>
    </div>

    <div class="action-controls">

      <!-- Status Update Dropdown -->
      <div class="control-group" id="statusUpdateGroup">
        <label>Update Status</label>
        <select id="statusSelect">
          <option value="">-- Select New Status --</option>

          <% 
            const current = item.itemStatus || "Pending";

            // Full delivery workflow in order
            const deliveryWorkflow = [
              "Pending",
              "Confirmed",
              "Processing",
              "Shipped",
              "Out for Delivery",
              "Delivered"
            ];

            // Get all statuses AFTER the current one
            let allowedNext = [];
            const currentIndex = deliveryWorkflow.indexOf(current);

            if (currentIndex !== -1 && currentIndex < deliveryWorkflow.length - 1) {
              allowedNext = deliveryWorkflow.slice(currentIndex + 1);
            }

            // Special case: if current is Pending, allow everything from Confirmed onward
            if (current === "Pending") {
              allowedNext = deliveryWorkflow.slice(1); // Confirmed to Delivered
            }

            // Allow "Cancelled" for non-final states
            const finalStatuses = ["Delivered", "Cancelled", "ReturnRequested", "ReturnApproved", "Returned"];
            if (!finalStatuses.includes(current)) {
              if (!allowedNext.includes("Cancelled")) {
                allowedNext.push("Cancelled");
              }
            }

            // Remove duplicates
            allowedNext = [...new Set(allowedNext)];
          %>

          <% allowedNext.forEach(status => { %>
            <option value="<%= status %>"><%= status %></option>
          <% }); %>
        </select>

        <button id="updateStatus" class="btn-update">Update Status</button>
      </div>

      <!-- Helpful Messages -->
      <% if (["Delivered", "Cancelled", "ReturnRequested", "ReturnApproved", "Returned"].includes(item.itemStatus)) { %>
        <div class="info-note" style="margin-top: 1.5rem; padding: 1rem; background: #f3f4f6; border-radius: 8px; text-align: center; font-size: 1rem;">
          <strong>Status is final:</strong> No further updates possible.
        </div>
      <% } else if (item.itemStatus === "Out for Delivery") { %>
        <div class="info-note" style="margin-top: 1.5rem; padding: 1rem; background: #fffbeb; border-radius: 8px; border-left: 4px solid #f59e0b; font-size: 1rem;">
          <strong>Next step:</strong> Mark as Delivered when handed to the customer.
        </div>
      <% } %>

      <!-- Return Actions -->
      <% if (item.itemStatus === 'ReturnRequested') { %>
        <div class="return-controls" style="margin-top: 2rem;">
          <button id="approveReturn" class="btn-approve">Approve Return</button>
          <button id="rejectReturn" class="btn-reject">Reject Return</button>
        </div>
      <% } %>

      <!-- Mark as Returned -->
      <% if (item.itemStatus === 'ReturnApproved') { %>
        <div style="margin-top: 2rem;">
          <button id="markReturned" class="btn-mark-returned">
            Mark as Returned & Restore Stock
          </button>
        </div>
      <% } %>

    </div>
  </div>

  <!-- Bottom Buttons -->
  <div class="bottom-actions">
    <a href="/admin/orders/print/<%= order._id %>" target="_blank" class="btn-print">
      Print Full Invoice
    </a>
    <a href="/admin/orders" class="btn-back-large">
      Back to Orders
    </a>
  </div>
</div>

<script>
  const ORDER_ID = "<%= order._id %>";
  const ITEM_INDEX = <%= itemIndex %>;

  function toast(msg, type = "info") {
    Toastify({
      text: msg,
      duration: 4000,
      gravity: "top",
      position: "right",
      backgroundColor: type === "success" ? "#16a34a" : type === "error" ? "#dc2626" : "#f59e0b"
    }).showToast();
  }

  // Hide status update section if no options available (final status)
  document.addEventListener('DOMContentLoaded', () => {
    const statusUpdateGroup = document.getElementById('statusUpdateGroup');
    const select = document.getElementById('statusSelect');

    if (statusUpdateGroup && select && select.options.length <= 1) {
      statusUpdateGroup.style.display = 'none';
    }
  });

  // Update Status
  document.getElementById('updateStatus')?.addEventListener('click', async () => {
    const status = document.getElementById('statusSelect').value;
    if (!status) return toast('Please select a status', 'error');

    try {
      const res = await axios.post(`/admin/orders/${ORDER_ID}/update-item`, {
        itemIndex: ITEM_INDEX,
        status
      });
      toast(res.data.success ? 'Status updated successfully!' : res.data.message || 'Update failed', 
            res.data.success ? 'success' : 'error');
      if (res.data.success) {
        setTimeout(() => location.reload(), 1500);
      }
    } catch (err) {
      toast('Server error. Please try again.', 'error');
    }
  });

  // Approve Return
  document.getElementById('approveReturn')?.addEventListener('click', async () => {
    if (!confirm('Approve this return request?')) return;
    try {
      const res = await axios.post(`/admin/orders/${ORDER_ID}/approve-return`, { itemIndex: ITEM_INDEX });
      toast(res.data.success ? 'Return approved!' : 'Failed to approve', res.data.success ? 'success' : 'error');
      if (res.data.success) setTimeout(() => location.reload(), 1500);
    } catch (err) {
      toast('Server error', 'error');
    }
  });

  // Reject Return
  document.getElementById('rejectReturn')?.addEventListener('click', async () => {
    if (!confirm('Reject this return request?')) return;
    try {
      const res = await axios.post(`/admin/orders/${ORDER_ID}/reject-return`, { itemIndex: ITEM_INDEX });
      toast(res.data.success ? 'Return rejected' : 'Failed to reject', res.data.success ? 'success' : 'error');
      if (res.data.success) setTimeout(() => location.reload(), 1500);
    } catch (err) {
      toast('Server error', 'error');
    }
  });

  // Mark as Returned
  document.getElementById('markReturned')?.addEventListener('click', async () => {
    if (!confirm('Mark as returned and restore stock?')) return;
    try {
      const res = await axios.post(`/admin/orders/${ORDER_ID}/mark-returned-item`, { itemIndex: ITEM_INDEX });
      toast(res.data.success ? 'Item marked as returned!' : res.data.message || 'Failed', 
            res.data.success ? 'success' : 'error');
      if (res.data.success) setTimeout(() => location.reload(), 1500);
    } catch (err) {
      toast('Server error', 'error');
    }
  });
</script>

</body>
</html>