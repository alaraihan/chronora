<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Admin</title>
  <link rel="stylesheet" href="/css/admin/orders.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>

<main class="main-content">
  <header class="content-header">
    <h1><i class="bi bi-cart-check"></i> Order Management (Line Items)</h1>
  </header>

  <div class="filters-card">
    <div class="filter-row">
      <div class="filter-group">
        <input 
          type="text" 
          id="searchInput"
          placeholder="Search by Order ID, Customer, Phone, Product..."
          class="search-input"
          value="<%= search || '' %>"
        >
      </div>
      
      <div class="filter-group">
        <select id="statusFilter" class="status-select">
          <option value="">All Status</option>
          <option value="Pending">Pending</option>
          <option value="Confirmed">Confirmed</option>
          <option value="Processing">Processing</option>
          <option value="Shipped">Shipped</option>
          <option value="Out for Delivery">Out for Delivery</option>
          <option value="Delivered">Delivered</option>
          <option value="Cancelled">Cancelled</option>
          <option value="ReturnRequested">Return Requested</option>
          <option value="ReturnApproved">Return Approved</option>
          <option value="Returned">Returned</option>
        </select>
      </div>

      <div class="filter-actions">
        <button onclick="applyFilters()" class="btn btn-primary">
          <i class="bi bi-funnel"></i> Apply Filters
        </button>
        <a href="/admin/orders" class="btn btn-secondary">
          <i class="bi bi-x-circle"></i> Clear All
        </a>
      </div>
    </div>
  </div>

  <div class="orders-summary">
    <div class="summary-card">
      <h3 id="totalOrders">0</h3>
      <p>Total Line Items</p>
    </div>
    <div class="summary-text">
      Individual product status per order
    </div>
  </div>

  <div class="table-container">
    <table class="orders-table">
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Customer</th>
          <th>Date</th>
          <th>Product</th>
          <th>Qty</th>
          <th>Price</th> 
          <th>Amount Paid</th> 
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="ordersTableBody"></tbody>
    </table>
  </div>

  <div class="pagination" id="paginationContainer"></div>
</main>

<div id="loadingOverlay" class="loading-overlay">
  <i class="bi bi-hourglass-split" style="font-size: 2.5rem;"></i>
  <div>Loading orders...</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const overlay = document.getElementById("loadingOverlay");
const totalOrdersEl = document.getElementById("totalOrders");

function showLoading() { overlay.style.display = "flex"; }
function hideLoading() { overlay.style.display = "none"; }

function toast(message) {
  Toastify({
    text: message,
    duration: 3000,
    gravity: "bottom",
    position: "right",
    backgroundColor: "#dc3545"
  }).showToast();
}

function applyFilters() {
  const search = document.getElementById("searchInput").value.trim();
  const status = document.getElementById("statusFilter").value;

  params.set("page", "1");
  if (search) params.set("search", search); else params.delete("search");
  if (status) params.set("status", status); else params.delete("status");

  updateURLAndLoad();
}

function goToPage(page) {
  params.set("page", page);
  updateURLAndLoad();
}

function updateURLAndLoad() {
  window.history.replaceState({}, "", `/admin/orders?${params.toString()}`);
  loadOrders();
}
function renderTable(lineItems) {
  const tbody = document.getElementById("ordersTableBody");
  tbody.innerHTML = "";

  if (!lineItems?.length) {
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center; padding:50px; color:#888; font-size:1.1rem;">No matching line items found</td></tr>`;
    return;
  }

  lineItems.forEach(item => {
    const prod = item.products?.[0] || {};                    // ← safe
    const product = prod.productId || {};
    const variant = prod.variantId || {};

    const unitPrice = prod.price || product.price || 0;
    const amountPaid = item.totalAmount || 0;
    const quantity = prod.quantity || 0;
    const status = prod.itemStatus || "Unknown";

    const row = document.createElement("tr");
    row.innerHTML = `
      <td><strong>${item.orderId || '—'}</strong></td>
      <td>${item.address?.fullName || "Guest"}</td>
      <td>${item.createdAt ? new Date(item.createdAt).toLocaleDateString('en-GB', { 
        day: '2-digit', month: '2-digit', year: 'numeric' 
      }) : '—'}</td>
      <td>
        <div>
          <div><strong>${product.name || 'Unknown Product'}</strong></div>
          <small>${variant.colorName || ''}${variant.size ? ' · ' + variant.size : ''}</small>
        </div>
      </td>
      <td>${quantity}</td>
      <td>₹${unitPrice.toLocaleString('en-IN')}</td>
      <td style="font-weight:bold; color:#00ff9d;">
        ₹${amountPaid.toLocaleString('en-IN')}
      </td>
      <td><span class="status-badge status-${status.toLowerCase().replace(/ /g, '-')}">${status}</span></td>
      <td>
        <a href="/admin/orders/${item._id}/${item.itemIndex}/detail" class="btn-small btn-primary">View Detail</a>
      </td>
    `;
    tbody.appendChild(row);
  });
}

function renderPagination(pag) {
  const container = document.getElementById("paginationContainer");
  container.innerHTML = "";

  if (pag.totalPages <= 1) return;

  let html = '<div style="display:flex; justify-content:center; align-items:center; gap:15px; margin-top:30px;">';

  if (pag.currentPage > 1) {
    html += `<button onclick="goToPage(${pag.currentPage - 1})" class="btn btn-secondary">Previous</button>`;
  }

  html += `<span style="font-weight:bold; font-size:1.1rem;">Page ${pag.currentPage} of ${pag.totalPages}</span>`;

  if (pag.currentPage < pag.totalPages) {
    html += `<button onclick="goToPage(${pag.currentPage + 1})" class="btn btn-primary">Next</button>`;
  }

  html += '</div>';
  container.innerHTML = html;
}

function loadOrders() {
  showLoading();

  axios.get(`/admin/orders/data?${params.toString()}`)
    .then(res => {
      if (!res.data.success) {
        toast("Failed to load orders");
        return;
      }

      totalOrdersEl.textContent = res.data.pagination.totalOrders || 0;
      renderTable(res.data.orders || []);
      renderPagination(res.data.pagination);
    })
    .catch(err => {
      console.error("Load error:", err);
      toast("Error loading data from server");
    })
    .finally(() => hideLoading());
}

document.addEventListener("DOMContentLoaded", () => {
  const searchVal = params.get("search");
  const statusVal = params.get("status");

  if (searchVal) document.getElementById("searchInput").value = searchVal;
  if (statusVal) document.getElementById("statusFilter").value = statusVal;

  loadOrders();
});
</script>

</body>
</html>