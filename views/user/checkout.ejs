<link rel="stylesheet" href="/css/user/checkout.css" />

<div class="checkout-wrapper">
  <div class="checkout-container">
    <h2 class="page-title">Checkout</h2>

    <div class="checkout-main">
      <!-- LEFT SIDE -->
      <div class="checkout-left">

        <!-- ADDRESS SECTION -->
        <div class="section-card">
          <h3>Select Delivery Address</h3>
          <div id="addressList">
            <% if (addresses && addresses.length > 0) { %>
              <% addresses.forEach((addr, index) => { %>
                <label class="address-option <%= index === 0 ? 'selected' : '' %>" data-id="<%= addr._id %>">
                  <input 
                    type="radio" 
                    name="selectedAddress" 
                    value="<%= addr._id %>" 
                    <%= index === 0 ? 'checked' : '' %> 
                  />
                  <div class="address-content">
                    <div class="address-header">
                      <strong><%= addr.name || 'No Name' %></strong>
                      <% if (addr.isDefaultShipping) { %>
                        <span class="default-badge">Default</span>
                      <% } %>
                    </div>
                    <p>
                      <%= addr.street || '' %><%= addr.street ? ',' : '' %>
                      <%= addr.city || '' %><%= addr.city ? ',' : '' %>
                      <%= addr.state || '' %> <%= addr.zip || '' %>
                    </p>
                    <p>Mobile: <%= addr.phone || 'Not provided' %></p>
                  </div>
                </label>
              <% }) %>
            <% } else { %>
              <p style="color:#999; text-align:center; padding:20px;">
                No saved addresses yet. Add one below.
              </p>
            <% } %>
          </div>

          <button type="button" class="add-address-btn" id="openAddressModal">
            + Add New Address
          </button>
        </div>

        <!-- PAYMENT METHOD SECTION -->
        <div class="section-card payment-section">
          <h3>Select Payment Method</h3>
          
          <label class="payment-option" data-method="cod">
            <input type="radio" name="paymentMethod" value="cod" id="cod">
            <div class="payment-content">
              <strong>Cash on Delivery</strong>
              <p>Pay when you receive your order</p>
            </div>
          </label>

          <label class="payment-option" data-method="wallet">
            <input type="radio" name="paymentMethod" value="wallet" id="wallet">
            <div class="payment-content">
              <strong>Wallet</strong>
              <p>Balance: ‚Çπ<span id="walletBalanceDisplay"><%= walletBalance.toLocaleString('en-IN') %></span></p>
            </div>
          </label>

          <label class="payment-option" data-method="razorpay">
            <input type="radio" name="paymentMethod" value="razorpay" id="razorpay">
            <div class="payment-content">
              <strong>Razorpay</strong>
              <p>Card ‚Ä¢ UPI ‚Ä¢ Netbanking</p>
            </div>
          </label>
        </div>

      </div>

      <!-- RIGHT SIDE - ORDER SUMMARY -->
      <div class="checkout-right">
        <div class="section-card order-summary">
          <h3>Order Summary</h3>
          
          <!-- CART ITEMS -->
          <div class="summary-items">
            <% (cartItems || []).forEach(item => { %>
              <div class="summary-item">
                <img 
                  src="<%= item.variantId?.images?.[0] || '/images/default.jpg' %>" 
                  alt="<%= item.productId?.name || 'Product' %>"
                >
                <div class="item-info">
                  <p><%= item.productId?.name || 'Unknown Product' %></p>
                  <small>
                    <%= item.variantId?.colorName || item.variantId?.color || 'Standard' %> √ó <%= item.quantity %>
                  </small>

                  <div style="margin-top:8px; font-size:14px;">
                    <% if (item.productId?.offerData) { %>
                      <del style="color:#999;">‚Çπ <%= item.productId.price.toLocaleString('en-IN') %> each</del>
                      <strong style="color:#2ecc71; margin-left:8px;">
                        ‚Çπ <%= item.productId.offerData.offerPrice.toLocaleString('en-IN') %> each
                      </strong>
                      <div style="color:#e74c3c; font-weight:600; font-size:13px; margin-top:4px;">
                        You saved ‚Çπ <%= ((item.productId.price - item.productId.offerData.offerPrice) * item.quantity).toLocaleString('en-IN') %>!
                      </div>
                    <% } else { %>
                      <strong style="color:#667eea;">
                        ‚Çπ <%= item.price.toLocaleString('en-IN') %> each
                      </strong>
                    <% } %>
                  </div>
                </div>
                <strong style="font-size:16px;">
                  ‚Çπ <%= (item.price * item.quantity).toLocaleString('en-IN') %>
                </strong>
              </div>
            <% }) %>
          </div>
<div id="soldOutMessage" style="display:none; color:red; font-weight:bold; margin-top:20px;">
  ‚ö†Ô∏è This item is sold out or no longer available for payment.
</div>


          <hr>

          <!-- COUPON SECTION -->
          <div class="coupon-section mt-3">
            <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
              <div style="position: relative; flex: 1;">
                <input type="text" id="couponCode" class="form-control" placeholder="Enter coupon code" style="text-transform: uppercase; padding-right: 40px;">
                <button type="button" id="removeCouponBtn" style="display: none; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #ef4444; font-size: 20px; font-weight: bold; cursor: pointer; padding: 4px 8px; line-height: 1;">√ó</button>
              </div>
              <button type="button" id="applyCouponBtn" class="btn btn-outline-primary">Apply</button>
            </div>
            <button type="button" id="viewCouponsBtn" class="btn btn-link" style="padding: 0; text-decoration: none; font-size: 14px;">
              üéüÔ∏è View Available Coupons
            </button>
            <small id="couponMessage" class="text-danger mt-1" style="display:none;"></small>
            <small id="couponSuccess" class="text-success mt-1" style="display:none;"></small>
          </div>

          <hr>

          <!-- PRICE BREAKDOWN -->
          <div class="summary-row">
            <span>Subtotal</span>
            <span>‚Çπ<span id="subtotalDisplay"><%= (subtotal || 0).toLocaleString('en-IN') %></span></span>
          </div>

          <div class="summary-row">
            <span>Delivery Charge</span>
            <span id="shippingDisplay" style="color:#4ade80;">
              <%= (subtotal || 0) >= 15000 ? 'FREE' : '‚Çπ100' %>
            </span>
          </div>

          <div class="summary-row" id="discountRow" style="display:none; color:#2ecc71;">
            <span>Coupon Discount</span>
            <span>- ‚Çπ<span id="discountAmount">0</span></span>
          </div>

          <div class="summary-total">
            <span>Grand Total</span>
            <strong>‚Çπ<span id="grandTotalDisplay">
              <%= ((subtotal || 0) + ((subtotal || 0) < 15000 ? 100 : 0)).toLocaleString('en-IN') %>
            </span></strong>
          </div>

          <div class="summary-row text-success fw-bold" id="walletPayable" style="display:none;">
            <span>Payable from Wallet</span>
            <span>‚Çπ<span id="walletPayableAmount"><%= grandTotal.toLocaleString('en-IN') %></span></span>
          </div>

          <button class="place-order-btn" id="placeOrderBtn">Place Order</button>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Add New Address Modal -->
<div id="addressModal" class="modal-overlay" style="display:none;">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add New Address</h3>
      <span class="close-modal" id="closeModal">√ó</span>
    </div>

    <form id="addressForm">
      <div class="form-grid">
        <div class="form-group">
          <label>Full Name *</label>
          <input type="text" name="name" required />
        </div>
        <div class="form-group">
          <label>Mobile *</label>
          <input type="text" name="phone" required maxlength="10" pattern="[0-9]{10}" />
        </div>
        <div class="form-group full-width">
          <label>Street Address / House No. *</label>
          <input type="text" name="street" required />
        </div>
        <div class="form-group">
          <label>City *</label>
          <input type="text" name="city" required />
        </div>
        <div class="form-group">
          <label>State *</label>
          <input type="text" name="state" required />
        </div>
        <div class="form-group">
          <label>ZIP Code *</label>
          <input type="text" name="zip" required maxlength="6" pattern="[0-9]{6}" />
        </div>
        <div class="form-group full-width">
          <label>
            <input type="checkbox" name="isDefaultShipping" />
            Set as default shipping address
          </label>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn-cancel" id="cancelBtn">Cancel</button>
        <button type="submit" class="btn-save">Save Address</button>
      </div>
    </form>
  </div>
</div>

<div id="couponsModal" class="modal-overlay" style="display:none;">
  <div class="modal-content" style="max-width: 700px;">
    <div class="modal-header">
      <h3>Available Coupons</h3>
      <span class="close-modal" id="closeCouponsModal">√ó</span>
    </div>
    
    <div id="couponsContainer" style="max-height: 500px; overflow-y: auto; padding: 20px;">
      <div class="text-center" style="padding: 40px;">
        <p>Loading coupons...</p>
      </div>
    </div>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="/js/user/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
