<link rel="stylesheet" href="/css/user/orderDetail.css">

<div class="order-details-container">


  <main class="order-content">
    <div class="order-header">
      <h1>Order <%= order.orderId %></h1>
      <p class="order-date">Placed on <%= new Date(order.createdAt).toLocaleDateString("en-GB") %></p>
      <p class="total-amount">Total: ‚Çπ<%= order.totalAmount.toLocaleString('en-IN') %></p>
      <span class="order-status status-<%= order.status.toLowerCase() %>"><%= order.status %></span>
    </div>

    <div class="order-items-container">
      <h3>Order Items (<%= order.products.length %>)</h3>
      <% order.products.forEach(function(p) { %>
      <div class="order-item">
        <img src="<%= p.variantId?.images?.[0] || '/images/default-watch.jpg' %>" 
             alt="<%= p.productId?.name || 'Product' %>"
             onerror="this.src='/images/default-watch.jpg'">
        <div class="item-info">
          <h4><%= p.productId?.name || 'Product unavailable' %></h4>
          <p class="variant">Variant: <%= p.variantId?.colorName || 'Standard' %></p>
          <p class="quantity">Qty: <%= p.quantity %> √ó ‚Çπ<%= p.price.toLocaleString('en-IN') %></p>
        </div>
        <div class="item-total">‚Çπ<%= (p.quantity * p.price).toLocaleString('en-IN') %></div>
      </div>
      <% }) %>
    </div>

    <div class="order-actions">
      <button id="btnTrack" 
              class="btn-primary" 
              <%= order.status === 'Cancelled' ? 'disabled' : '' %>>
        üì¶ Track Order
      </button>

      <button id="btnCancel" 
              class="btn-danger" 
              <%= !['Pending', 'Processing'].includes(order.status) ? 'disabled' : '' %>>
        ‚úñ Cancel Order
      </button>

      <button id="btnReturn" 
              class="btn-warning" 
              <%= order.status !== 'Delivered' ? 'disabled' : '' %>>
        üîÑ Return Order
      </button>

      <button id="btnReview" 
              class="btn-success" 
              <%= order.status !== 'Delivered' ? 'disabled' : '' %>>
        ‚≠ê Rate & Review
      </button>

      <button id="btnInvoice" class="btn-secondary">
        üìÑ Download Invoice
      </button>

      <button id="btnReorder" 
              class="btn-info" 
              <%= !['Delivered', 'Cancelled', 'Returned', 'Refunded'].includes(order.status) ? 'disabled' : '' %>>
        üîÑ Reorder
      </button>
    </div>
  </main>
</div>

<div id="modalTrack" class="modal">
  <div class="modal-backdrop" data-close="modalTrack"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Track Order <%= order.orderId %></h2>
      <span class="close" data-close="modalTrack">√ó</span>
    </div>
    <div class="modal-body">
      <div class="timeline">
        <% 
          const timelineSteps = [
            { id: 'ordered', title: 'Order Placed', date: new Date(order.createdAt), completed: true },
            { id: 'confirmed', title: 'Order Confirmed', date: order.status !== 'Pending' ? new Date(order.createdAt).setHours(order.createdAt.getHours() + 1) : null, completed: ['Processing', 'Shipped', 'Delivered'].includes(order.status) },
            { id: 'processing', title: 'Processing', date: ['Processing', 'Shipped', 'Delivered'].includes(order.status) ? new Date(order.createdAt).setHours(order.createdAt.getHours() + 2) : null, completed: ['Shipped', 'Delivered'].includes(order.status) },
            { id: 'shipped', title: 'Shipped', date: ['Shipped', 'Delivered'].includes(order.status) ? new Date(order.createdAt).setHours(order.createdAt.getHours() + 24) : null, completed: order.status === 'Delivered' },
            { id: 'delivered', title: 'Delivered', date: order.status === 'Delivered' ? new Date(order.createdAt).setHours(order.createdAt.getHours() + 48) : null, completed: order.status === 'Delivered' }
          ];
          
          let activeFound = false;
          timelineSteps.forEach(step => {
            const isActive = step.completed && !activeFound && order.status !== 'Delivered';
            activeFound = activeFound || isActive;
        %>
        <div class="timeline-item <%= step.completed ? 'completed' : '' %> <%= isActive ? 'active' : '' %>">
          <div class="timeline-icon">
            <% if (step.id === 'ordered') { %>‚úì<% } %>
            <% if (step.id === 'confirmed') { %>‚úì<% } %>
            <% if (step.id === 'processing') { %>‚öô<% } %>
            <% if (step.id === 'shipped') { %>üöö<% } %>
            <% if (step.id === 'delivered') { %>üè†<% } %>
          </div>
          <div class="timeline-content">
            <h4><%= step.title %></h4>
            <% if (step.date) { %>
              <p>Order <%= step.title.toLowerCase() %> successfully</p>
              <div class="timeline-date"><%= new Date(step.date).toLocaleString() %></div>
            <% } else { %>
              <p>Waiting for <%= step.title.toLowerCase() %></p>
            <% } %>
          </div>
        </div>
        <% }); %>
      </div>
      
      <% if (order.trackingNumber) { %>
      <div class="tracking-info" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
        <p><strong>Tracking Number:</strong> <%= order.trackingNumber %></p>
        <p><strong>Carrier:</strong> <%= order.shippingCarrier || 'Standard Shipping' %></p>
        <p><a href="<%= order.trackingLink || '#' %>" target="_blank" style="color: #2563eb; text-decoration: none;">
          ‚Üó Track on carrier website
        </a></p>
      </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Cancel Order Modal -->
<div id="modalCancel" class="modal">
  <div class="modal-backdrop" data-close="modalCancel"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Cancel Order <%= order.orderId %></h2>
      <span class="close" data-close="modalCancel">√ó</span>
    </div>
    <div class="modal-body">
      <p class="modal-subtitle">Please select a reason for cancellation:</p>
      <div class="radio-group">
        <label class="radio-label">
          <input type="radio" name="cancelReason" value="Ordered by mistake" checked>
          <span class="radio-text">Ordered by mistake</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="cancelReason" value="Found better price">
          <span class="radio-text">Found better price</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="cancelReason" value="Delivery delay">
          <span class="radio-text">Delivery delay</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="cancelReason" value="Changed my mind">
          <span class="radio-text">Changed my mind</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="cancelReason" value="Other">
          <span class="radio-text">Other reason</span>
        </label>
      </div>
      <div class="form-group" id="otherReasonContainer" style="display: none;">
        <label for="otherCancelReason">Please specify:</label>
        <input type="text" id="otherCancelReason" class="form-input" placeholder="Enter reason...">
      </div>
      <button id="confirmCancel" class="btn-confirm">Confirm Cancellation</button>
    </div>
  </div>
</div>

<!-- Return Order Modal -->
<div id="modalReturn" class="modal">
  <div class="modal-backdrop" data-close="modalReturn"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Return Order <%= order.orderId %></h2>
      <span class="close" data-close="modalReturn">√ó</span>
    </div>
    <div class="modal-body">
      <p class="modal-subtitle">Please select a reason for return:</p>
      <div class="radio-group">
        <label class="radio-label">
          <input type="radio" name="returnReason" value="Product damaged" checked>
          <span class="radio-text">Product damaged</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="returnReason" value="Wrong item received">
          <span class="radio-text">Wrong item received</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="returnReason" value="Quality not as expected">
          <span class="radio-text">Quality not as expected</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="returnReason" value="Not satisfied">
          <span class="radio-text">Not satisfied</span>
        </label>
        <label class="radio-label">
          <input type="radio" name="returnReason" value="Size/color issue">
          <span class="radio-text">Size/color issue</span>
        </label>
      </div>
      <div class="form-group">
        <label for="refundMethod">Refund Method:</label>
        <select id="refundMethod" class="form-select">
          <option value="original_payment">Original payment method</option>
          <option value="wallet">Wallet credit</option>
          <option value="bank_transfer">Bank transfer</option>
        </select>
      </div>
      <div class="form-group">
        <label for="returnComments">Additional Comments (Optional):</label>
        <textarea id="returnComments" rows="3" placeholder="Any additional details..."></textarea>
      </div>
      <button id="submitReturn" class="btn-confirm">Submit Return Request</button>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div id="modalReview" class="modal">
  <div class="modal-backdrop" data-close="modalReview"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Rate & Review</h2>
      <span class="close" data-close="modalReview">√ó</span>
    </div>
    <div class="modal-body">
      <p class="modal-subtitle">Share your experience with this product:</p>
      
      <div class="form-group">
        <label>Rating:</label>
        <div class="star-rating" style="font-size: 28px; color: #ffd700; margin: 10px 0 20px;">
          <span class="star" data-rating="1">‚òÜ</span>
          <span class="star" data-rating="2">‚òÜ</span>
          <span class="star" data-rating="3">‚òÜ</span>
          <span class="star" data-rating="4">‚òÜ</span>
          <span class="star" data-rating="5">‚òÜ</span>
        </div>
        <input type="hidden" id="ratingValue" value="0">
      </div>
      
      <div class="form-group">
        <label for="reviewTitle">Review Title:</label>
        <input type="text" id="reviewTitle" class="form-input" placeholder="Summarize your experience...">
      </div>
      
      <div class="form-group">
        <label for="reviewText">Your Review:</label>
        <textarea id="reviewText" rows="5" placeholder="Write your detailed review here..."></textarea>
      </div>
      
      <button id="submitReview" class="btn-confirm" disabled>Submit Review</button>
    </div>
  </div>
</div>

<!-- Invoice Modal -->
<div id="modalInvoice" class="modal">
  <div class="modal-backdrop" data-close="modalInvoice"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Download Invoice</h2>
      <span class="close" data-close="modalInvoice">√ó</span>
    </div>
    <div class="modal-body">
      <div class="invoice-details">
        <div class="invoice-row">
          <span class="invoice-label">Invoice Number:</span>
          <span class="invoice-value">INV-<%= order.orderId %></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-label">Order Date:</span>
          <span class="invoice-value"><%= new Date(order.createdAt).toLocaleDateString() %></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-label">Total Amount:</span>
          <span class="invoice-value">‚Çπ<%= order.totalAmount.toLocaleString('en-IN') %></span>
        </div>
        <div class="invoice-row">
          <span class="invoice-label">Status:</span>
          <span class="invoice-value"><%= order.status %></span>
        </div>
      </div>
      
      <p class="modal-subtitle">Choose download option:</p>
      <div class="download-options">
        <button id="downloadPDF" class="btn-download btn-pdf">
          üì• Download PDF
        </button>
        <button id="emailInvoice" class="btn-download btn-email">
          üìß Email Invoice
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reorder Modal -->
<div id="modalReorder" class="modal">
  <div class="modal-backdrop" data-close="modalReorder"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Reorder Items</h2>
      <span class="close" data-close="modalReorder">√ó</span>
    </div>
    <div class="modal-body">
      <p class="modal-subtitle">Click on any item to view and reorder:</p>
      
      <% order.products.forEach((p, index) => { %>
      <a href="/product/<%= p.productId?._id %>" 
         class="reorder-item-link" 
         style="display: flex; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 10px; text-decoration: none; color: inherit; transition: all 0.2s; cursor: pointer;">
        <img src="<%= p.variantId?.images?.[0] || '/images/default-watch.jpg' %>" 
             alt="<%= p.productId?.name %>"
             style="width: 50px; height: 50px; border-radius: 4px; margin-right: 12px; object-fit: cover;">
        <div style="flex: 1;">
          <strong style="color: #000; font-size: 1em;"><%= p.productId?.name || 'Product' %></strong>
          <div style="font-size: 0.9em; color: #666; margin-top: 3px;">
            <%= p.variantId?.colorName || 'Standard' %> √ó <%= p.quantity %>
          </div>
        </div>
        <div style="display: flex; align-items: center; gap: 10px;">
          <span style="font-weight: bold; color: #2ecc71;">
            ‚Çπ<%= (p.quantity * p.price).toLocaleString('en-IN') %>
          </span>
          <svg width="18" height="18" fill="none" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
            <polyline points="9 18 15 12 9 6"></polyline>
          </svg>
        </div>
      </a>
      <% }) %>
      
      <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee;">
        <p style="text-align: center; color: #666; font-size: 0.9em; margin: 0;">
          Click any item to view product details and add to cart
        </p>
      </div>
    </div>
  </div>
</div>
  
<script src="/js/user/orderDetail.js"></script>
