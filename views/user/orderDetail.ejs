<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
    <%= title %> | Chronora
  </title>
  <link rel="stylesheet" href="/css/user/orderDetail.css">
  <link rel="stylesheet" href="/css/user/profile-shared.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link
    href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=DM+Mono:wght@300;400;500&family=Outfit:wght@300;400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>

<body>
  <%- include('../partials/user/header') %>

    <% const productId=requestedProductId; const variantId=requestedVariantId; let itemIndex=0; let
      item=order.products[0]; if (productId && variantId) { const foundIndex=order.products.findIndex(p=>
      p.productId?._id?.toString() === productId &&
      p.variantId?._id?.toString() === variantId
      );
      if (foundIndex !== -1) { item = order.products[foundIndex]; itemIndex = foundIndex; }
      }
      const canCancel = ["Pending", "Confirmed", "Processing"].includes(item.itemStatus);
      const canReturn = item.itemStatus === "Delivered";
      const canReview = item.itemStatus === "Delivered";
      const hasReviewed = order.reviews?.some(r =>
      r.productId?.toString() === item.productId?._id?.toString() &&
      r.variantId?.toString() === item.variantId?._id?.toString()
      );
      const statusClass = item.itemStatus.toLowerCase().replace(/\s+/g, '-');
      const timelineDate = item.itemTimeline
      ? (item.itemTimeline.deliveredAt || item.itemTimeline.shippedAt || item.itemTimeline.outForDeliveryAt ||
      item.itemTimeline.cancelledAt || item.itemTimeline.returnRequestedAt)
      : null;
      %>

      <div class="profile-layout">
        <%- include('../partials/user/sidebar') %>
          <main class="profile-content">
            <div class="page-wrapper">
              <!-- Ambient glows -->
              <div class="glow glow-1"></div>
              <div class="glow glow-2"></div>

              <div class="container">

                <!-- Back Navigation -->
                <nav class="back-nav">
                  <a href="/profile/orders" class="btn-back">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <path d="M19 12H5M12 5l-7 7 7 7" />
                    </svg>
                    Back to Orders
                  </a>
                </nav>

                <!-- Page Header -->
                <header class="page-header">
                  <div class="header-left">
                    <p class="header-eyebrow">Order Details</p>
                    <h1 class="header-title">
                      <span class="accent">
                        <%= order.orderId %>
                      </span>
                    </h1>
                    <div class="order-meta">
                      <span class="order-date">Placed <%= new Date(order.createdAt).toLocaleDateString("en-GB", {
                          day: 'numeric' , month: 'long' , year: 'numeric' }) %></span>
                      <span class="dot">Â·</span>
                      <span class="order-id-pill">Chronora</span>
                    </div>
                  </div>
                  <div class="header-actions">
                    <button type="button" id="btnTrack" class="btn-sm">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                        <circle cx="12" cy="12" r="10" />
                        <path d="M12 8v4l3 3" />
                      </svg>
                      Track Item
                    </button>
                    <% const isOrderCancellable=order.products.every(p=>
                      ["Pending", "Confirmed", "Processing"].includes(p.itemStatus)
                      ) && !["Cancelled", "Returned", "Delivered", "ReturnRequested"].includes(order.status);
                      %>
                      <% if (isOrderCancellable) { %>
                        <button type="button" class="btn-sm btn-cancel-entire"
                          onclick="cancelEntireOrder('<%= order._id %>')">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="15" y1="9" x2="9" y2="15" />
                            <line x1="9" y1="9" x2="15" y2="15" />
                          </svg>
                          Cancel Order
                        </button>
                        <% } %>
                          <button type="button" id="btnInvoice" class="btn-sm">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                              <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z" />
                              <polyline points="14 2 14 8 20 8" />
                              <line x1="16" y1="13" x2="8" y2="13" />
                              <line x1="16" y1="17" x2="8" y2="17" />
                            </svg>
                            Invoice
                          </button>
                  </div>
                </header>

                <!-- Main Item Card -->
                <div class="item-card" data-index="<%= itemIndex %>">
                  <div class="item-card-top">
                    <span class="status-badge <%= statusClass %>">
                      <span class="status-dot"></span>
                      <%= item.itemStatus %>
                    </span>
                    <% if (timelineDate) { %>
                      <span class="status-date">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="12"
                          height="12">
                          <rect x="3" y="4" width="18" height="18" rx="2" />
                          <line x1="16" y1="2" x2="16" y2="6" />
                          <line x1="8" y1="2" x2="8" y2="6" />
                          <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                        <%= new Date(timelineDate).toLocaleDateString('en-GB', { day: 'numeric' , month: 'short' ,
                          year: 'numeric' }) %>
                      </span>
                      <% } %>
                  </div>

                  <div class="item-body">
                    <div class="item-image-wrap">
                      <div class="image-glow"></div>
                      <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>"
                        alt="<%= item.productId?.name %>" class="item-img">
                    </div>

                    <div class="item-details">
                      <h2 class="item-name">
                        <a href="/product/<%= item.productId?._id %>">
                          <%= item.productId?.name %>
                        </a>
                      </h2>

                      <div class="item-meta-row">
                        <span class="meta-pill">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="11"
                            height="11">
                            <circle cx="12" cy="12" r="10" />
                          </svg>
                          <%= item.variantId?.colorName || 'Standard' %>
                        </span>
                        <span class="meta-pill">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="11"
                            height="11">
                            <path d="M6 2L3 6v14a2 2 0 002 2h14a2 2 0 002-2V6l-3-4z" />
                          </svg>
                          Qty: <%= item.quantity %>
                        </span>
                      </div>

                      <div class="price-block">
                        <% if (item.price < item.originalPrice) { %>
                          <span class="price-original">â‚¹<%= (item.originalPrice * item.quantity).toLocaleString('en-IN')
                              %>
                          </span>
                          <span class="price-main">â‚¹<%= (item.price * item.quantity).toLocaleString('en-IN') %></span>
                          <span class="price-savings">You saved â‚¹<%= ((item.originalPrice - item.price) *
                              item.quantity).toLocaleString('en-IN') %></span>
                          <% } else { %>
                            <span class="price-main">â‚¹<%= (item.price * item.quantity).toLocaleString('en-IN') %></span>
                            <% } %>
                      </div>

                      <% if (item.reason) { %>
                        <div class="reason-box">
                          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="14"
                            height="14">
                            <circle cx="12" cy="12" r="10" />
                            <line x1="12" y1="8" x2="12" y2="12" />
                            <line x1="12" y1="16" x2="12.01" y2="16" />
                          </svg>
                          <span><strong>Reason:</strong>
                            <%= item.reason %>
                          </span>
                        </div>
                        <% } %>

                          <% const activeStatuses=[ 'Pending' , 'Confirmed' , 'Processing' , 'Shipped'
                            , 'Out for Delivery' ]; if (order.expectedDelivery &&
                            activeStatuses.includes(item.itemStatus)) { %>
                            <div class="delivery-box">
                              <div class="delivery-icon-wrap">ðŸ“¦</div>
                              <div>
                                <p class="delivery-label">Expected Delivery</p>
                                <p class="delivery-date">
                                  <%= new Date(order.expectedDelivery).toLocaleDateString('en-GB', { weekday: 'long' ,
                                    year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                                </p>
                              </div>
                            </div>
                            <% } %>

                              <div class="item-actions">
                                <% if (canCancel) { %>
                                  <button type="button" class="btn-action btn-cancel">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                      width="13" height="13">
                                      <circle cx="12" cy="12" r="10" />
                                      <line x1="15" y1="9" x2="9" y2="15" />
                                      <line x1="9" y1="9" x2="15" y2="15" />
                                    </svg>
                                    Cancel Item
                                  </button>
                                  <% } %>
                                    <% if (canReturn) { %>
                                      <button type="button" class="btn-action btn-return">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"
                                          width="13" height="13">
                                          <polyline points="1 4 1 10 7 10" />
                                          <path d="M3.51 15a9 9 0 102.13-9.36L1 10" />
                                        </svg>
                                        Return Item
                                      </button>
                                      <% } %>
                                        <% if (canReview && !hasReviewed) { %>
                                          <button type="button" class="btn-action btn-review">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                              stroke-width="1.8" width="13" height="13">
                                              <polygon
                                                points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                            </svg>
                                            Write Review
                                          </button>
                                          <% } else if (canReview && hasReviewed) { %>
                                            <span class="reviewed-badge">
                                              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                stroke-width="2" width="13" height="13">
                                                <polyline points="20 6 9 17 4 12" />
                                              </svg>
                                              Review Submitted
                                            </span>
                                            <% } %>
                                              <% if (item.productId?._id) { %>
                                                <a href="/product/<%= item.productId._id %>"
                                                  class="btn-action btn-view">
                                                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                                    stroke-width="1.8" width="13" height="13">
                                                    <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6" />
                                                    <polyline points="15 3 21 3 21 9" />
                                                    <line x1="10" y1="14" x2="21" y2="3" />
                                                  </svg>
                                                  View Product
                                                </a>
                                                <% } %>
                              </div>
                    </div>
                  </div>
                </div>

                <!-- Info Grid -->
                <div class="info-grid">
                  <div class="info-card">
                    <h3 class="card-label">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="13"
                        height="13">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z" />
                        <circle cx="12" cy="10" r="3" />
                      </svg>
                      Shipping Address
                    </h3>
                    <div class="info-content">
                      <p class="info-name">
                        <%= order.address.fullName %>
                      </p>
                      <p>
                        <%= order.address.address1 %>
                      </p>
                      <% if (order.address.address2) { %>
                        <p>
                          <%= order.address.address2 %>
                        </p>
                        <% } %>
                          <p>
                            <%= order.address.city %>, <%= order.address.state %> â€” <%= order.address.pincode %>
                          </p>
                          <p class="info-phone">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="12"
                              height="12">
                              <path
                                d="M22 16.92v3a2 2 0 01-2.18 2 19.79 19.79 0 01-8.63-3.07A19.5 19.5 0 013.07 10.8a19.79 19.79 0 01-3.07-8.67A2 2 0 012 0h3a2 2 0 012 1.72c.127.96.361 1.903.7 2.81a2 2 0 01-.45 2.11L6.09 7.91a16 16 0 006 6l1.27-1.27a2 2 0 012.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0122 14.92z" />
                            </svg>
                            <%= order.address.phone %>
                          </p>
                    </div>
                  </div>

                  <div class="info-card">
                    <h3 class="card-label">
                      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="13"
                        height="13">
                        <rect x="1" y="4" width="22" height="16" rx="2" />
                        <line x1="1" y1="10" x2="23" y2="10" />
                      </svg>
                      Payment Information
                    </h3>
                    <div class="info-content">
                      <div class="payment-method">
                        <%= order.paymentMethod.toUpperCase() %>
                      </div>
                      <div class="payment-status-row">
                        <span class="info-label">Status</span>
                        <span class="status-badge <%= order.paymentStatus.toLowerCase() %>">
                          <span class="status-dot"></span>
                          <%= order.paymentStatus %>
                        </span>
                      </div>
                      <% if (order.paymentId) { %>
                        <div class="payment-id">
                          <span class="info-label">Payment ID</span>
                          <code><%= order.paymentId %></code>
                        </div>
                        <% } %>
                    </div>
                  </div>
                </div>

                <!-- Price Breakdown -->
                <div class="price-card">
                  <h3 class="card-label">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" width="13"
                      height="13">
                      <line x1="12" y1="1" x2="12" y2="23" />
                      <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6" />
                    </svg>
                    Price Breakdown
                  </h3>
                  <div class="price-rows">
                    <div class="price-row">
                      <span class="pr-label">Subtotal <span class="pr-qty">Ã—<%= item.quantity %></span></span>
                      <span class="pr-value">â‚¹<%= (item.price * item.quantity).toLocaleString('en-IN') %></span>
                    </div>
                    <div class="price-row">
                      <span class="pr-label">Delivery Charges</span>
                      <span class="pr-value <%= order.deliveryCharge === 0 ? 'free' : '' %>">
                        <%= order.deliveryCharge===0 ? 'FREE' : 'â‚¹' + order.deliveryCharge.toLocaleString('en-IN') %>
                      </span>
                    </div>
                    <% if (order.discount> 0) { %>
                      <div class="price-row">
                        <span class="pr-label">Coupon Discount</span>
                        <span class="pr-value discount">âˆ’ â‚¹<%= order.discount.toLocaleString('en-IN') %></span>
                      </div>
                      <% } %>
                        <div class="price-divider"></div>
                        <div class="price-row total-row">
                          <span class="pr-label total-label">Amount Paid</span>
                          <span class="pr-value total-value">â‚¹<%= order.totalAmount.toLocaleString('en-IN') %></span>
                        </div>
                  </div>
                </div>

              </div><!-- /container -->
            </div><!-- /page-wrapper -->

            <!-- ===== MODALS ===== -->

            <!-- Track Modal -->
            <div id="modalTrack" class="modal-overlay">
              <div class="modal-content track-modal">
                <div class="modal-header">
                  <h3>Track Your Item</h3>
                  <span class="close-modal" data-close="modalTrack">Ã—</span>
                </div>
                <div class="modal-body">
                  <div class="current-status-box">
                    <span class="status-badge-large <%= statusClass %>">
                      <span class="status-dot"></span>
                      <%= item.itemStatus %>
                    </span>
                    <% if (item.itemTimeline?.deliveredAt) { %>
                      <p class="track-info">Delivered on <%= new
                          Date(item.itemTimeline.deliveredAt).toLocaleDateString('en-GB', { weekday: 'long' ,
                          year: 'numeric' , month: 'long' , day: 'numeric' }) %>
                      </p>
                      <% } else if (item.itemTimeline?.outForDeliveryAt) { %>
                        <p class="track-info">Out for delivery â€” arriving soon!</p>
                        <% } else if (item.itemTimeline?.shippedAt) { %>
                          <p class="track-info">Shipped â€” on its way!</p>
                          <% } %>
                  </div>

                  <div class="tracking-timeline">
                    <% const timeline=item.itemTimeline || {}; const events=[ { key: 'confirmedAt' ,
                      label: 'Order Confirmed' , icon: 'âœ“' }, { key: 'processedAt' , label: 'Processing' , icon: 'âš™ï¸' },
                      { key: 'shippedAt' , label: 'Shipped' , icon: 'ðŸšš' }, { key: 'outForDeliveryAt' ,
                      label: 'Out for Delivery' , icon: 'ðŸ“¦' }, { key: 'deliveredAt' , label: 'Delivered' , icon: 'ðŸ ' }
                      ]; let hasAnyEvent=false; events.forEach(event=> {
                      if (timeline[event.key]) { hasAnyEvent = true;
                      %>
                      <div
                        class="timeline-event <%= timeline.deliveredAt && event.key === 'deliveredAt' ? 'current' : 'completed' %>">
                        <div class="event-icon-wrap">
                          <%= event.icon %>
                        </div>
                        <div class="event-content">
                          <span class="event-title">
                            <%= event.label %>
                          </span>
                          <span class="event-date">
                            <%= new Date(timeline[event.key]).toLocaleDateString('en-GB', { day: 'numeric' ,
                              month: 'short' , year: 'numeric' }) %>
                          </span>
                        </div>
                      </div>
                      <% } }); if (!hasAnyEvent) { %>
                        <div class="no-timeline">
                          <p>No tracking information yet.</p>
                          <p>Your order is being prepared.</p>
                        </div>
                        <% } %>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cancel Modal -->
            <div id="modalCancel" class="modal-overlay">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>Cancel Item</h3>
                  <span class="close-modal" data-close="modalCancel">Ã—</span>
                </div>
                <div class="modal-body">
                  <div class="modal-item-preview">
                    <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>"
                      alt="<%= item.productId?.name %>">
                    <div>
                      <strong>
                        <%= item.productId?.name %>
                      </strong>
                      <small>
                        <%= item.variantId?.colorName || 'Standard' %> Â· Qty <%= item.quantity %>
                      </small>
                    </div>
                  </div>
                  <p class="modal-subtitle">Select a reason</p>
                  <div class="radio-group" id="cancelRadioGroup">
                    <label><input type="radio" name="cancelReason" value="Ordered by mistake" checked> Ordered by
                      mistake</label>
                    <label><input type="radio" name="cancelReason" value="Found better price"> Found better price
                      elsewhere</label>
                    <label><input type="radio" name="cancelReason" value="Changed my mind"> Changed my mind</label>
                    <label><input type="radio" name="cancelReason" value="Other"> Other</label>
                  </div>
                  <div class="modal-actions">
                    <button type="button" class="btn-cancel-modal" data-close="modalCancel">No, Keep it</button>
                    <button id="submitCancel" class="btn-confirm-danger">Confirm Cancellation</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Return Modal -->
            <div id="modalReturn" class="modal-overlay">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>Return Item</h3>
                  <span class="close-modal" data-close="modalReturn">Ã—</span>
                </div>
                <div class="modal-body">
                  <div class="modal-item-preview">
                    <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>"
                      alt="<%= item.productId?.name %>">
                    <div>
                      <strong>
                        <%= item.productId?.name %>
                      </strong>
                      <small>
                        <%= item.variantId?.colorName || 'Standard' %> Â· Qty <%= item.quantity %>
                      </small>
                    </div>
                  </div>
                  <p class="modal-subtitle">Select a reason</p>
                  <div class="radio-group">
                    <label><input type="radio" name="returnReason" value="Damaged" checked> Damaged or defective</label>
                    <label><input type="radio" name="returnReason" value="Wrong item"> Wrong item received</label>
                    <label><input type="radio" name="returnReason" value="Size issue"> Size/color issue</label>
                    <label><input type="radio" name="returnReason" value="Not satisfied"> Not satisfied</label>
                    <label><input type="radio" name="returnReason" value="Other"> Other</label>
                  </div>
                  <div class="modal-actions">
                    <button type="button" class="btn-cancel-modal" data-close="modalReturn">Cancel</button>
                    <button id="submitReturn" class="btn-confirm">Submit Return Request</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Review Modal -->
            <div id="modalReview" class="modal-overlay">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>Write a Review</h3>
                  <span class="close-modal" data-close="modalReview">Ã—</span>
                </div>
                <div class="modal-body">
                  <div class="modal-item-preview">
                    <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>"
                      alt="<%= item.productId?.name %>">
                    <div>
                      <strong>
                        <%= item.productId?.name %>
                      </strong>
                      <small>
                        <%= item.variantId?.colorName || 'Standard' %>
                      </small>
                    </div>
                  </div>
                  <div class="star-rating-wrap">
                    <p class="modal-subtitle">Your Rating</p>
                    <div class="stars">
                      <span class="star" data-value="1">â˜…</span>
                      <span class="star" data-value="2">â˜…</span>
                      <span class="star" data-value="3">â˜…</span>
                      <span class="star" data-value="4">â˜…</span>
                      <span class="star" data-value="5">â˜…</span>
                    </div>
                    <p class="rating-text-label" id="ratingText">Tap a star to rate</p>
                  </div>
                  <input type="hidden" id="ratingInput" value="0">
                  <div class="review-text-wrap">
                    <p class="modal-subtitle">Your Review</p>
                    <textarea id="reviewText" class="review-textarea" rows="5"
                      placeholder="Share your experience with this watch... Quality, design, comfort?"></textarea>
                  </div>
                  <div class="modal-actions">
                    <button type="button" class="btn-cancel-modal" data-close="modalReview">Cancel</button>
                    <button id="submitReviewBtn" class="btn-confirm" disabled>Submit Review</button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Invoice Modal -->
            <div id="modalInvoice" class="modal-overlay">
              <div class="modal-content">
                <div class="modal-header">
                  <h3>Invoice</h3>
                  <span class="close-modal" data-close="modalInvoice">Ã—</span>
                </div>
                <div class="modal-body invoice-body">
                  <div class="invoice-icon">ðŸ“„</div>
                  <p>Your invoice is ready to view and download.</p>
                  <div class="modal-actions">
                    <button type="button" class="btn-cancel-modal" data-close="modalInvoice">Cancel</button>
                    <a href="/profile/orders/<%= order.orderId %>/invoice" target="_blank" class="btn-confirm">
                      Download Invoice
                    </a>
                  </div>
                </div>
              </div>
            </div>

            <script src="/js/user/orderDetail.js"></script>
            <script>
              const ORDER_ID = "<%= order._id %>";
              const ITEM_INDEX = parseInt("<%= itemIndex %>") || 0;


              function toast(message, type = 'info') {
                const colors = {
                  success: '#16a34a',
                  error: '#dc2626',
                  info: '#c9a96e',
                };
                Toastify({
                  text: message,
                  duration: 4500,
                  gravity: 'top',
                  position: 'right',
                  style: {
                    background: colors[type] || colors.info,
                    borderRadius: '10px',
                    fontFamily: "'DM Mono', monospace",
                    fontSize: '13px',
                    padding: '12px 20px',
                    boxShadow: '0 8px 32px rgba(0,0,0,0.4)',
                  },
                  stopOnFocus: true,
                }).showToast();
              }

              /* ---------- Modal Helpers ---------- */
              function openModal(id) {
                const el = document.getElementById(id);
                if (el) {
                  el.classList.add('active');
                  document.body.style.overflow = 'hidden';
                }
              }

              function closeModal(id) {
                const el = document.getElementById(id);
                if (el) {
                  el.classList.remove('active');
                  document.body.style.overflow = '';
                }
              }

              /* ---------- Init ---------- */
              document.addEventListener('DOMContentLoaded', () => {

                /* â”€â”€ Close triggers (close-modal + btn-cancel-modal + [data-close] buttons) â”€â”€ */
                document.querySelectorAll('.close-modal, .btn-cancel-modal, [data-close]').forEach(el => {
                  el.addEventListener('click', (e) => {
                    if (e.target !== el && el.classList.contains('modal-overlay')) return;
                    const id = el.dataset.close;
                    if (id) closeModal(id);
                    else el.closest('.modal-overlay')?.classList.remove('active');
                    if (el.classList.contains('modal-overlay')) closeModal(el.id);
                  });
                });

                /* Esc key */
                document.addEventListener('keydown', e => {
                  if (e.key === 'Escape') {
                    document.querySelectorAll('.modal-overlay.active').forEach(m => {
                      m.classList.remove('active');
                      document.body.style.overflow = '';
                    });
                  }
                });

                /* â”€â”€ Header Buttons â”€â”€ */
                document.getElementById('btnTrack')?.addEventListener('click', () => openModal('modalTrack'));
                document.getElementById('btnInvoice')?.addEventListener('click', () => openModal('modalInvoice'));

                /* â”€â”€ Cancel Button â”€â”€ */
                document.querySelectorAll('.btn-cancel').forEach(btn => {
                  btn.addEventListener('click', async () => {
                    try {
                      const res = await fetch(`/profile/orders/${ORDER_ID}/check-cancel?itemIndex=${ITEM_INDEX}`);
                      const data = await res.json();

                      if (data.isAlreadyCancelled) {
                        toast('This item has already been cancelled.', 'error');
                        setTimeout(() => location.reload(), 2000);
                        return;
                      }
                      if (!data.isCancellable) {
                        toast(`Cannot cancel â€” current status: ${data.currentStatus}`, 'error');
                        return;
                      }
                      openModal('modalCancel');
                    } catch {
                      openModal('modalCancel'); // fallback: let the API handle it
                    }
                  });
                });

                /* â”€â”€ Return Button â”€â”€ */
                document.querySelectorAll('.btn-return').forEach(btn => {
                  btn.addEventListener('click', () => openModal('modalReturn'));
                });

                /* â”€â”€ Review Button â”€â”€ */
                document.querySelectorAll('.btn-review').forEach(btn => {
                  btn.addEventListener('click', () => openModal('modalReview'));
                });

                /* â”€â”€ "Other" text field for Cancel reasons â”€â”€ */
                const cancelGroup = document.getElementById('cancelRadioGroup');
                if (cancelGroup) {
                  const otherInput = document.createElement('input');
                  otherInput.type = 'text';
                  otherInput.placeholder = 'Please specify your reasonâ€¦';
                  otherInput.className = 'other-reason-input';
                  cancelGroup.appendChild(otherInput);

                  cancelGroup.querySelectorAll('input[name="cancelReason"]').forEach(radio => {
                    radio.addEventListener('change', () => {
                      otherInput.style.display = radio.value === 'Other' && radio.checked ? 'block' : 'none';
                    });
                  });
                }

                /* ============================================================
                   Submit: Cancel
                ============================================================ */
                const submitCancelBtn = document.getElementById('submitCancel');
                submitCancelBtn?.addEventListener('click', async () => {
                  let reason = document.querySelector('input[name="cancelReason"]:checked')?.value;
                  if (!reason) { toast('Please select a cancellation reason.', 'error'); return; }

                  if (reason === 'Other') {
                    const custom = document.querySelector('.other-reason-input')?.value.trim();
                    if (!custom) { toast('Please describe your reason.', 'error'); return; }
                    reason = custom;
                  }

                  setLoading(submitCancelBtn, true, 'Processingâ€¦');
                  try {
                    const res = await axios.post(`/order/${ORDER_ID}/cancel-item`, { itemIndex: ITEM_INDEX, reason });
                    if (res.data.success) {
                      toast('Item cancelled successfully.', 'success');
                      closeModal('modalCancel');
                      setTimeout(() => location.reload(), 1600);
                    } else {
                      handleAlreadyCancelled(res.data.message, 'Failed to cancel item.');
                    }
                  } catch (err) {
                    handleAlreadyCancelled(err.response?.data?.message, 'Something went wrong.');
                  } finally {
                    setLoading(submitCancelBtn, false, 'Confirm Cancellation');
                  }
                });

                function handleAlreadyCancelled(msg = '', fallback = '') {
                  if (msg.toLowerCase().includes('already cancelled')) {
                    toast('This item has already been cancelled.', 'error');
                    setTimeout(() => location.reload(), 2000);
                  } else {
                    toast(msg || fallback, 'error');
                  }
                }

                /* ============================================================
                   Submit: Return
                ============================================================ */
                const submitReturnBtn = document.getElementById('submitReturn');
                submitReturnBtn?.addEventListener('click', async () => {
                  const reason = document.querySelector('input[name="returnReason"]:checked')?.value;
                  if (!reason) { toast('Please select a return reason.', 'error'); return; }

                  setLoading(submitReturnBtn, true, 'Processingâ€¦');
                  try {
                    const res = await axios.post(`/order/${ORDER_ID}/return-item`, { itemIndex: ITEM_INDEX, reason });
                    if (res.data.success) {
                      toast('Return request submitted!', 'success');
                      closeModal('modalReturn');
                      setTimeout(() => location.reload(), 1600);
                    } else {
                      toast(res.data.message || 'Failed to submit return.', 'error');
                    }
                  } catch (err) {
                    toast(err.response?.data?.message || 'Something went wrong.', 'error');
                  } finally {
                    setLoading(submitReturnBtn, false, 'Submit Return Request');
                  }
                });

                /* ============================================================
                   Review Modal: Stars + Submit
                ============================================================ */
                const ratingInput = document.getElementById('ratingInput');
                const reviewTextEl = document.getElementById('reviewText');
                const ratingTextEl = document.getElementById('ratingText');
                const submitReviewBtn = document.getElementById('submitReviewBtn');

                const ratingLabels = ['', 'Very Bad', 'Poor', 'Average', 'Good', 'Excellent!'];

                function updateStars(value) {
                  document.querySelectorAll('.star').forEach((s, i) => {
                    s.classList.toggle('active', i < value);
                  });
                  if (ratingTextEl) ratingTextEl.textContent = ratingLabels[value] || '';
                }

                function checkReviewReady() {
                  const rating = parseInt(ratingInput?.value || '0');
                  const hasText = reviewTextEl?.value.trim().length > 0;
                  if (submitReviewBtn) submitReviewBtn.disabled = !(rating > 0 && hasText);
                }

                document.querySelectorAll('.star').forEach(star => {
                  star.addEventListener('click', () => {
                    const v = parseInt(star.dataset.value);
                    if (ratingInput) ratingInput.value = v;
                    updateStars(v);
                    checkReviewReady();
                  });

                  star.addEventListener('mouseenter', () => updateStars(parseInt(star.dataset.value)));
                  star.addEventListener('mouseleave', () => updateStars(parseInt(ratingInput?.value || '0')));
                });

                reviewTextEl?.addEventListener('input', checkReviewReady);

                submitReviewBtn?.addEventListener('click', async () => {
                  const rating = parseInt(ratingInput?.value || '0');
                  const text = reviewTextEl?.value.trim() || '';

                  if (!rating) { toast('Please select a star rating.', 'error'); return; }
                  if (!text) { toast('Please write your review.', 'error'); return; }

                  setLoading(submitReviewBtn, true, 'Submittingâ€¦');
                  try {
                    const res = await axios.post(`/order/${ORDER_ID}/review-item`, {
                      itemIndex: ITEM_INDEX, rating, text,
                    });
                    if (res.data.success) {
                      toast('Review submitted! ðŸŽ‰', 'success');
                      closeModal('modalReview');
                      setTimeout(() => location.reload(), 1600);
                    } else {
                      toast(res.data.message || 'Failed to submit review.', 'error');
                    }
                  } catch (err) {
                    toast(err.response?.data?.message || 'Server error.', 'error');
                  } finally {
                    setLoading(submitReviewBtn, false, 'Submit Review');
                  }
                });

                /* â”€â”€ Loading helper â”€â”€ */
                function setLoading(btn, isLoading, defaultText) {
                  btn.disabled = isLoading;
                  btn.textContent = isLoading ? defaultText : defaultText;
                }

              });
            </script>
      </div>
      </main>
      </div>
</body>

</html>