<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Chronora</title>
  <link rel="stylesheet" href="/css/user/orderDetail.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

<div class="order-details-container">
  <main class="order-content">
    <div class="back-navigation">
      <a href="/profile/orders" class="btn-back">‚Üê Back to Orders</a>
    </div>

    <div class="order-summary-header">
      <div class="summary-left">
        <h1>Order <%= order.orderId %></h1>
        <p class="order-date">Placed on <%= new Date(order.createdAt).toLocaleDateString("en-GB") %></p>
      </div>
      <div class="summary-right">
        <button type="button" id="btnTrack" class="btn-action-small">Track Item</button>
        <button type="button" id="btnInvoice" class="btn-action-small">Invoice</button>
      </div>
    </div>

    <%
      const productId = requestedProductId;
      const variantId = requestedVariantId;

      let itemIndex = 0;
      let item = order.products[0];

      if (productId && variantId) {
        const foundIndex = order.products.findIndex(p => 
          p.productId?._id?.toString() === productId && 
          p.variantId?._id?.toString() === variantId
        );
        if (foundIndex !== -1) {
          item = order.products[foundIndex];
          itemIndex = foundIndex;
        }
      }
    %>

    <div class="main-item-card" data-index="<%= itemIndex %>">
      <div class="item-status-bar">
        <span class="status-badge <%= item.itemStatus.toLowerCase().replace(/\s+/g, '-') %>">
          <%= item.itemStatus %>
        </span>
        <% if (item.itemTimeline) {
          const date = item.itemTimeline.deliveredAt || item.itemTimeline.shippedAt || item.itemTimeline.outForDeliveryAt || item.itemTimeline.cancelledAt || item.itemTimeline.returnRequestedAt;
          if (date) { %>
            <span class="status-date">on <%= new Date(date).toLocaleDateString('en-GB') %></span>
          <% }
        } %>
      </div>

      <div class="item-content-large">
        <div class="item-image-section-large">
          <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" 
               alt="<%= item.productId?.name %>" 
               class="item-image-large">
        </div>

        <div class="item-details-large">
          <h2 class="item-name-large">
            <a href="/product/<%= item.productId?._id %>"><%= item.productId?.name %></a>
          </h2>
          <p class="item-variant-large">Color: <%= item.variantId?.colorName || 'Standard' %></p>
          <p class="item-quantity-large">Quantity: <%= item.quantity %></p>
<!-- Discounted Price with Strikethrough + Savings -->
<div class="item-price-large">
  <% if (item.price < item.originalPrice) { %>
    <del style="color:#999; font-size:18px;">
      ‚Çπ <%= (item.originalPrice * item.quantity).toLocaleString('en-IN') %>
    </del>
    <div style="font-size:28px; font-weight:bold; color:#2ecc71; margin:8px 0;">
      ‚Çπ <%= (item.price * item.quantity).toLocaleString('en-IN') %>
    </div>
    <div style="color:#e74c3c; font-weight:600; font-size:16px;">
      You saved ‚Çπ <%= ((item.originalPrice - item.price) * item.quantity).toLocaleString('en-IN') %> with offer!
    </div>
  <% } else { %>
    <div style="font-size:28px; font-weight:bold; color:#667eea;">
      ‚Çπ <%= (item.price * item.quantity).toLocaleString('en-IN') %>
    </div>
  <% } %>
</div>
          <% if (item.reason) { %>
            <div class="item-reason-box">
              <strong>Reason:</strong> <%= item.reason %>
            </div>
          <% } %>

          <% if (order.expectedDelivery && ['Pending','Confirmed','Processing','Shipped','Out for Delivery'].includes(item.itemStatus)) { %>
            <div class="expected-delivery-box">
              <div class="delivery-icon">üì¶</div>
              <div>
                <p class="delivery-label">Expected Delivery</p>
                <p class="delivery-date"><%= new Date(order.expectedDelivery).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
              </div>
            </div>
          <% } %>

          <div class="item-actions-large">
            <% 
              const canCancel = ["Pending", "Confirmed", "Processing"].includes(item.itemStatus);
              const canReturn = item.itemStatus === "Delivered";
              const canReview = item.itemStatus === "Delivered";
              const hasReviewed = order.reviews?.some(r => 
                r.productId?.toString() === item.productId?._id?.toString() && 
                r.variantId?.toString() === item.variantId?._id?.toString()
              );
            %>

            <% if (canCancel) { %>
              <button type="button" class="btn-action-large btn-cancel">Cancel This Item</button>
            <% } %>

            <% if (canReturn) { %>
              <button type="button" class="btn-action-large btn-return">Return This Item</button>
            <% } %>

            <% if (canReview && !hasReviewed) { %>
              <button type="button" class="btn-action-large btn-review">Write a Review</button>
            <% } else if (canReview && hasReviewed) { %>
              <div class="reviewed-badge-large">‚úì Review Submitted</div>
            <% } %>

            <a href="/product/<%= item.productId?._id %>" class="btn-action-large btn-view-product">
              View Product Page
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Address & Payment Info -->
    <div class="info-grid">
      <div class="info-card">
        <h3>Shipping Address</h3>
        <div class="info-content">
          <p><strong><%= order.address.fullName %></strong></p>
          <p><%= order.address.address1 %></p>
          <% if (order.address.address2) { %><p><%= order.address.address2 %></p><% } %>
          <p><%= order.address.city %>, <%= order.address.state %> - <%= order.address.pincode %></p>
          <p>üìû <%= order.address.phone %></p>
        </div>
      </div>

      <div class="info-card">
        <h3>Payment Information</h3>
        <div class="info-content">
          <p>Method: <strong><%= order.paymentMethod.toUpperCase() %></strong></p>
          <p>Status: <span class="status-badge <%= order.paymentStatus.toLowerCase() %>"><%= order.paymentStatus %></span></p>
          <% if (order.paymentId) { %><p>Payment ID: <strong><%= order.paymentId %></strong></p><% } %>
        </div>
      </div>
    </div>

    <!-- Price Breakdown -->
    <div class="price-breakdown-card">
      <h3>Price Details</h3>
      <div class="price-row">
        <span>Item Total (√ó<%= item.quantity %>):</span>
        <span>‚Çπ<%= (item.price * item.quantity).toLocaleString('en-IN') %></span>
      </div>
      <div class="price-row">
        <span>Delivery Charges:</span>
        <span><%= order.deliveryCharge === 0 ? 'FREE' : '‚Çπ' + order.deliveryCharge.toLocaleString('en-IN') %></span>
      </div>
      <% if (order.discount > 0) { %>
        <div class="price-row discount">
          <span>Discount:</span>
          <span>-‚Çπ<%= order.discount.toLocaleString('en-IN') %></span>
        </div>
      <% } %>
      <div class="price-row total">
        <span><strong>Amount Paid:</strong></span>
        <span><strong>‚Çπ<%= order.totalAmount.toLocaleString('en-IN') %></strong></span>
      </div>
    </div>
  </main>
</div>

<!-- MODALS (Beautiful & Functional) -->
<div id="modalTrack" class="modal">
  <div class="modal-backdrop" data-close="modalTrack"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Track Your Item</h2>
      <span class="close" data-close="modalTrack">√ó</span>
    </div>
    <div class="modal-body">
      <div class="tracking-timeline">
        <div class="timeline-status-current">
          <span class="status-badge <%= item.itemStatus.toLowerCase().replace(/\s+/g, '-') %>">
            Current Status: <%= item.itemStatus %>
          </span>
        </div>
        <div class="timeline-events">
          <% 
            const timeline = item.itemTimeline || {};
            const events = [
              { key: 'confirmedAt', label: 'Order Confirmed' },
              { key: 'processedAt', label: 'Processing' },
              { key: 'shippedAt', label: 'Shipped' },
              { key: 'outForDeliveryAt', label: 'Out for Delivery' },
              { key: 'deliveredAt', label: 'Delivered' }
            ];
            events.forEach(event => {
              if (timeline[event.key]) { %>
                <div class="timeline-event completed">
                  <div class="event-dot"></div>
                  <div class="event-content">
                    <span class="event-title"><%= event.label %></span>
                    <span class="event-date"><%= new Date(timeline[event.key]).toLocaleDateString('en-GB') %></span>
                  </div>
                </div>
              <% }
            });
          %>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="modalCancel" class="modal">
  <div class="modal-backdrop" data-close="modalCancel"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Cancel This Item</h2>
      <span class="close" data-close="modalCancel">√ó</span>
    </div>
    <div class="modal-body">
      <div class="modal-item-preview">
        <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" alt="<%= item.productId?.name %>">
        <div>
          <strong><%= item.productId?.name %></strong><br>
          <small>Color: <%= item.variantId?.colorName || 'Standard' %> √ó <%= item.quantity %></small>
        </div>
      </div>
      <p class="modal-subtitle">Why are you cancelling?</p>
      <div class="radio-group">
        <label><input type="radio" name="cancelReason" value="Ordered by mistake" checked> Ordered by mistake</label>
        <label><input type="radio" name="cancelReason" value="Found better price"> Found better price elsewhere</label>
        <label><input type="radio" name="cancelReason" value="Changed my mind"> Changed my mind</label>
        <label><input type="radio" name="cancelReason" value="Other"> Other</label>
      </div>
      <button id="submitCancel" class="btn-confirm">Confirm Cancellation</button>
    </div>
  </div>
</div>

<div id="modalReturn" class="modal">
  <div class="modal-backdrop" data-close="modalReturn"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Return This Item</h2>
      <span class="close" data-close="modalReturn">√ó</span>
    </div>
    <div class="modal-body">
      <div class="modal-item-preview">
        <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" alt="<%= item.productId?.name %>">
        <div>
          <strong><%= item.productId?.name %></strong><br>
          <small>Color: <%= item.variantId?.colorName || 'Standard' %> √ó <%= item.quantity %></small>
        </div>
      </div>
      <p class="modal-subtitle">Why are you returning this item?</p>
      <div class="radio-group">
        <label><input type="radio" name="returnReason" value="Damaged" checked> Damaged or defective</label>
        <label><input type="radio" name="returnReason" value="Wrong item"> Wrong item received</label>
        <label><input type="radio" name="returnReason" value="Size issue"> Size/color issue</label>
        <label><input type="radio" name="returnReason" value="Not satisfied"> Not satisfied</label>
        <label><input type="radio" name="returnReason" value="Other"> Other</label>
      </div>
      <button id="submitReturn" class="btn-confirm">Submit Return Request</button>
    </div>
  </div>
</div>

<div id="modalReview" class="modal">
  <div class="modal-backdrop" data-close="modalReview"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Write a Review</h2>
      <span class="close" data-close="modalReview">√ó</span>
    </div>
    <div class="modal-body">
      <div class="review-product-preview">
        <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" alt="<%= item.productId?.name %>">
        <div>
          <strong><%= item.productId?.name %></strong><br>
          <small><%= item.variantId?.colorName || 'Standard' %></small>
        </div>
      </div>
      <p class="modal-subtitle">Rate this product</p>
      <div class="star-rating">
        <span class="star" data-value="1">‚òÖ</span>
        <span class="star" data-value="2">‚òÖ</span>
        <span class="star" data-value="3">‚òÖ</span>
        <span class="star" data-value="4">‚òÖ</span>
        <span class="star" data-value="5">‚òÖ</span>
      </div>
      <input type="hidden" id="ratingInput" value="0">
      <textarea id="reviewText" class="form-input" rows="5" placeholder="Share your experience..."></textarea>
      <button id="submitReviewBtn" class="btn-confirm" disabled>Submit Review</button>
    </div>
  </div>
</div>

<div id="modalInvoice" class="modal">
  <div class="modal-backdrop" data-close="modalInvoice"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Invoice</h2>
      <span class="close" data-close="modalInvoice">√ó</span>
    </div>
    <div class="modal-body text-center">
      <p>Download your invoice</p>
      <a href="/order/<%= order._id %>/invoice" target="_blank" class="btn-confirm">Download PDF</a>
    </div>
  </div>
</div>

<script>
  const ORDER_ID = "<%= order._id %>";
  const ITEM_INDEX = <%= itemIndex %>;

  function toast(message, type = "info") {
    Toastify({
      text: message,
      duration: 4000,
      gravity: "bottom",
      position: "right",
      backgroundColor: type === "success" ? "#16a34a" : type === "error" ? "#dc2626" : "#f59e0b"
    }).showToast();
  }

  // Open Modal
  function openModal(id) {
    document.getElementById(id).classList.add('active');
  }

  // Close Modal
  document.querySelectorAll('[data-close], .modal-backdrop').forEach(el => {
    el.addEventListener('click', () => {
      el.closest('.modal').classList.remove('active');
    });
  });

  // Track
  document.getElementById('btnTrack')?.addEventListener('click', () => openModal('modalTrack'));

  // Invoice
  document.getElementById('btnInvoice')?.addEventListener('click', () => openModal('modalInvoice'));

  // Cancel
  document.querySelector('.btn-cancel')?.addEventListener('click', () => openModal('modalCancel'));

  // Return
  document.querySelector('.btn-return')?.addEventListener('click', () => openModal('modalReturn'));

  // Review
  document.querySelector('.btn-review')?.addEventListener('click', () => openModal('modalReview'));

  // Cancel Submit
  document.getElementById('submitCancel')?.addEventListener('click', async () => {
    const reason = document.querySelector('input[name="cancelReason"]:checked')?.value || 'No reason';
    try {
      const res = await axios.post(`/order/${ORDER_ID}/cancel-item`, { itemIndex: ITEM_INDEX, reason });
      toast(res.data.success ? 'Cancelled!' : res.data.message || 'Failed', res.data.success ? 'success' : 'error');
      if (res.data.success) setTimeout(() => location.reload(), 1500);
    } catch (err) {
      toast('Server error', 'error');
    }
  });

  // Return Submit
  document.getElementById('submitReturn')?.addEventListener('click', async () => {
    const reason = document.querySelector('input[name="returnReason"]:checked')?.value || 'No reason';
    try {
      const res = await axios.post(`/order/${ORDER_ID}/return-item`, { itemIndex: ITEM_INDEX, reason });
      toast(res.data.success ? 'Return requested!' : res.data.message || 'Failed', res.data.success ? 'success' : 'error');
      if (res.data.success) setTimeout(() => location.reload(), 1500);
    } catch (err) {
      toast('Server error', 'error');
    }
  });

  // Review Submit
  document.getElementById('submitReviewBtn')?.addEventListener('click', async () => {
    const rating = document.getElementById('ratingInput').value;
    const text = document.getElementById('reviewText').value.trim();
    if (!text) return toast('Write your review', 'error');

    try {
      const res = await axios.post(`/order/${ORDER_ID}/review-item`, { itemIndex: ITEM_INDEX, rating: Number(rating), text });
      toast(res.data.success ? 'Review submitted!' : res.data.message || 'Failed', res.data.success ? 'success' : 'error');
      if (res.data.success) setTimeout(() => location.reload(), 1500);
    } catch (err) {
      toast('Server error', 'error');
    }
  });

  // Star Rating
  document.querySelectorAll('.star').forEach(star => {
    star.addEventListener('click', () => {
      const value = star.dataset.value;
      document.getElementById('ratingInput').value = value;
      document.querySelectorAll('.star').forEach(s => s.style.color = '#e5e7eb');
      document.querySelectorAll(`.star[data-value="${value}"]`).forEach((s, i) => {
        s.style.color = i < value ? '#f59e0b' : '#e5e7eb';
      });
      document.getElementById('submitReviewBtn').disabled = false;
    });
  });
</script>
</body>
</html>