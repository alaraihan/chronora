<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | Chronora</title>
  <link rel="stylesheet" href="/css/user/orderDetail.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
</head>
<body>

<div class="order-details-container">
  <main class="order-content">
    <div class="back-navigation">
      <a href="/profile/orders" class="btn-back">‚Üê Back to Orders</a>
    </div>

    <div class="order-summary-header">
      <div class="summary-left">
        <h1>Order <%= order.orderId %></h1>
        <p class="order-date">Placed on <%= new Date(order.createdAt).toLocaleDateString("en-GB") %></p>
      </div>
      <div class="summary-right">
        <button type="button" id="btnTrack" class="btn-action-small">Track Item</button>
        <button type="button" id="btnInvoice" class="btn-action-small">Invoice</button>
      </div>
    </div>

    <%
      const productId = requestedProductId;
      const variantId = requestedVariantId;

      let itemIndex = 0;
      let item = order.products[0];

      if (productId && variantId) {
        const foundIndex = order.products.findIndex(p => 
          p.productId?._id?.toString() === productId && 
          p.variantId?._id?.toString() === variantId
        );
        if (foundIndex !== -1) {
          item = order.products[foundIndex];
          itemIndex = foundIndex;
        }
      }
    %>

    <div class="main-item-card" data-index="<%= itemIndex %>">
      <div class="item-status-bar">
        <span class="status-badge <%= item.itemStatus.toLowerCase().replace(/\s+/g, '-') %>">
          <%= item.itemStatus %>
        </span>
        <% if (item.itemTimeline) {
          const date = item.itemTimeline.deliveredAt || item.itemTimeline.shippedAt || item.itemTimeline.outForDeliveryAt || item.itemTimeline.cancelledAt || item.itemTimeline.returnRequestedAt;
          if (date) { %>
            <span class="status-date">on <%= new Date(date).toLocaleDateString('en-GB') %></span>
          <% }
        } %>
      </div>

      <div class="item-content-large">
        <div class="item-image-section-large">
          <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" 
               alt="<%= item.productId?.name %>" 
               class="item-image-large">
        </div>

        <div class="item-details-large">
          <h2 class="item-name-large">
            <a href="/product/<%= item.productId?._id %>"><%= item.productId?.name %></a>
          </h2>
          <p class="item-variant-large">Color: <%= item.variantId?.colorName || 'Standard' %></p>
          <p class="item-quantity-large">Quantity: <%= item.quantity %></p>
<!-- Discounted Price with Strikethrough + Savings -->
<div class="item-price-large">
  <% if (item.price < item.originalPrice) { %>
    <del style="color:#999; font-size:18px;">
      ‚Çπ <%= (item.originalPrice * item.quantity).toLocaleString('en-IN') %>
    </del>
    <div style="font-size:28px; font-weight:bold; color:#2ecc71; margin:8px 0;">
      ‚Çπ <%= (item.price * item.quantity).toLocaleString('en-IN') %>
    </div>
    <div style="color:#e74c3c; font-weight:600; font-size:16px;">
      You saved ‚Çπ <%= ((item.originalPrice - item.price) * item.quantity).toLocaleString('en-IN') %> with offer!
    </div>
  <% } else { %>
    <div style="font-size:28px; font-weight:bold; color:#667eea;">
      ‚Çπ <%= (item.price * item.quantity).toLocaleString('en-IN') %>
    </div>
  <% } %>
</div>
          <% if (item.reason) { %>
            <div class="item-reason-box">
              <strong>Reason:</strong> <%= item.reason %>
            </div>
          <% } %>

          <% if (order.expectedDelivery && ['Pending','Confirmed','Processing','Shipped','Out for Delivery'].includes(item.itemStatus)) { %>
            <div class="expected-delivery-box">
              <div class="delivery-icon">üì¶</div>
              <div>
                <p class="delivery-label">Expected Delivery</p>
                <p class="delivery-date"><%= new Date(order.expectedDelivery).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
              </div>
            </div>
          <% } %>

          <div class="item-actions-large">
            <% 
              const canCancel = ["Pending", "Confirmed", "Processing"].includes(item.itemStatus);
              const canReturn = item.itemStatus === "Delivered";
              const canReview = item.itemStatus === "Delivered";
              const hasReviewed = order.reviews?.some(r => 
                r.productId?.toString() === item.productId?._id?.toString() && 
                r.variantId?.toString() === item.variantId?._id?.toString()
              );
            %>

            <% if (canCancel) { %>
              <button type="button" class="btn-action-large btn-cancel">Cancel This Item</button>
            <% } %>

            <% if (canReturn) { %>
              <button type="button" class="btn-action-large btn-return">Return This Item</button>
            <% } %>

            <% if (canReview && !hasReviewed) { %>
              <button type="button" class="btn-action-large btn-review">Write a Review</button>
            <% } else if (canReview && hasReviewed) { %>
              <div class="reviewed-badge-large">‚úì Review Submitted</div>
            <% } %>

            <a href="/product/<%= item.productId?._id %>" class="btn-action-large btn-view-product">
              View Product Page
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Address & Payment Info -->
    <div class="info-grid">
      <div class="info-card">
        <h3>Shipping Address</h3>
        <div class="info-content">
          <p><strong><%= order.address.fullName %></strong></p>
          <p><%= order.address.address1 %></p>
          <% if (order.address.address2) { %><p><%= order.address.address2 %></p><% } %>
          <p><%= order.address.city %>, <%= order.address.state %> - <%= order.address.pincode %></p>
          <p>üìû <%= order.address.phone %></p>
        </div>
      </div>

      <div class="info-card">
        <h3>Payment Information</h3>
        <div class="info-content">
          <p>Method: <strong><%= order.paymentMethod.toUpperCase() %></strong></p>
          <p>Status: <span class="status-badge <%= order.paymentStatus.toLowerCase() %>"><%= order.paymentStatus %></span></p>
          <% if (order.paymentId) { %><p>Payment ID: <strong><%= order.paymentId %></strong></p><% } %>
        </div>
      </div>
    </div>

    <!-- Price Breakdown (UPDATED to show discount & final total) -->
    <div class="price-breakdown-card">
      <h3>Price Details</h3>
      <div class="price-row">
        <span>Subtotal (√ó<%= item.quantity %>):</span>
        <span>‚Çπ<%= (item.price * item.quantity).toLocaleString('en-IN') %></span>
      </div>
      <div class="price-row">
        <span>Delivery Charges:</span>
        <span><%= order.deliveryCharge === 0 ? 'FREE' : '‚Çπ' + order.deliveryCharge.toLocaleString('en-IN') %></span>
      </div>
      <% if (order.discount > 0) { %>
        <div class="price-row discount">
          <span>Coupon Discount:</span>
          <span style="color:#2ecc71;">- ‚Çπ<%= order.discount.toLocaleString('en-IN') %></span>
        </div>
      <% } %>
      <div class="price-row total">
        <span><strong>Amount Paid:</strong></span>
        <span><strong style="color:#00ff9d;">‚Çπ<%= order.totalAmount.toLocaleString('en-IN') %></strong></span>
      </div>
    </div>
  </main>
</div>

<div id="modalTrack" class="modal">
  <div class="modal-backdrop" data-close="modalTrack"></div>
  <div class="modal-box track-modal">
    <div class="modal-header">
      <h2>Track Your Item</h2>
      <span class="close" data-close="modalTrack">√ó</span>
    </div>
    <div class="modal-body">
      <!-- Current Status -->
      <div class="current-status-box">
        <span class="status-badge-large <%= item.itemStatus.toLowerCase().replace(/\s+/g, '-') %>">
          <%= item.itemStatus %>
        </span>
        <% if (item.itemTimeline?.deliveredAt) { %>
          <p class="delivered-date">Delivered on <%= new Date(item.itemTimeline.deliveredAt).toLocaleDateString('en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) %></p>
        <% } else if (item.itemTimeline?.outForDeliveryAt) { %>
          <p class="delivery-info">Out for delivery ‚Äî arriving soon!</p>
        <% } else if (item.itemTimeline?.shippedAt) { %>
          <p class="delivery-info">Shipped ‚Äî on its way!</p>
        <% } %>
      </div>

      <!-- Timeline -->
      <div class="tracking-timeline">
        <% 
          const timeline = item.itemTimeline || {};
          const events = [
            { key: 'confirmedAt', label: 'Order Confirmed', icon: '‚úì' },
            { key: 'processedAt', label: 'Processing', icon: '‚öôÔ∏è' },
            { key: 'shippedAt', label: 'Shipped', icon: 'üöö' },
            { key: 'outForDeliveryAt', label: 'Out for Delivery', icon: 'üì¶' },
            { key: 'deliveredAt', label: 'Delivered', icon: 'üè†' }
          ];

          let hasAnyEvent = false;
          events.forEach(event => {
            if (timeline[event.key]) {
              hasAnyEvent = true;
        %>
              <div class="timeline-event <%= timeline.deliveredAt && event.key === 'deliveredAt' ? 'current' : 'completed' %>">
                <div class="event-icon"><%= event.icon %></div>
                <div class="event-content">
                  <span class="event-title"><%= event.label %></span>
                  <span class="event-date"><%= new Date(timeline[event.key]).toLocaleDateString('en-GB') %></span>
                </div>
              </div>
        <%
            }
          });

          if (!hasAnyEvent) { %>
            <div class="no-timeline">
              <p>No tracking information available yet.</p>
              <p>Your order is being prepared.</p>
            </div>
          <% } %>
      </div>
    </div>
  </div>
</div>
<div id="modalCancel" class="modal">
  <div class="modal-backdrop" data-close="modalCancel"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Cancel This Item</h2>
      <span class="close" data-close="modalCancel">√ó</span>
    </div>
    <div class="modal-body">
      <div class="modal-item-preview">
        <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" alt="<%= item.productId?.name %>">
        <div>
          <strong><%= item.productId?.name %></strong><br>
          <small>Color: <%= item.variantId?.colorName || 'Standard' %> √ó <%= item.quantity %></small>
        </div>
      </div>
      <p class="modal-subtitle">Why are you cancelling?</p>
      <div class="radio-group">
        <label><input type="radio" name="cancelReason" value="Ordered by mistake" checked> Ordered by mistake</label>
        <label><input type="radio" name="cancelReason" value="Found better price"> Found better price elsewhere</label>
        <label><input type="radio" name="cancelReason" value="Changed my mind"> Changed my mind</label>
        <label><input type="radio" name="cancelReason" value="Other"> Other</label>
      </div>
      <button id="submitCancel" class="btn-confirm">Confirm Cancellation</button>
    </div>
  </div>
</div>

<div id="modalReturn" class="modal">
  <div class="modal-backdrop" data-close="modalReturn"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Return This Item</h2>
      <span class="close" data-close="modalReturn">√ó</span>
    </div>
    <div class="modal-body">
      <div class="modal-item-preview">
        <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" alt="<%= item.productId?.name %>">
        <div>
          <strong><%= item.productId?.name %></strong><br>
          <small>Color: <%= item.variantId?.colorName || 'Standard' %> √ó <%= item.quantity %></small>
        </div>
      </div>
      <p class="modal-subtitle">Why are you returning this item?</p>
      <div class="radio-group">
        <label><input type="radio" name="returnReason" value="Damaged" checked> Damaged or defective</label>
        <label><input type="radio" name="returnReason" value="Wrong item"> Wrong item received</label>
        <label><input type="radio" name="returnReason" value="Size issue"> Size/color issue</label>
        <label><input type="radio" name="returnReason" value="Not satisfied"> Not satisfied</label>
        <label><input type="radio" name="returnReason" value="Other"> Other</label>
      </div>
      <button id="submitReturn" class="btn-confirm">Submit Return Request</button>
    </div>
  </div>
</div>
<div id="modalReview" class="modal">
  <div class="modal-backdrop" data-close="modalReview"></div>
  <div class="modal-box review-modal">
    <div class="modal-header">
      <h2>Write a Review</h2>
      <span class="close" data-close="modalReview">√ó</span>
    </div>
    <div class="modal-body">
      <!-- Product Preview -->
      <div class="review-product-preview">
        <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>" alt="<%= item.productId?.name %>" class="review-product-img">
        <div class="review-product-info">
          <strong class="review-product-name"><%= item.productId?.name %></strong>
          <small class="review-variant"><%= item.variantId?.colorName || 'Standard' %></small>
        </div>
      </div>

      <!-- Star Rating -->
      <div class="review-rating-section">
        <p class="rating-label">Your Rating</p>
        <div class="star-rating">
          <span class="star" data-value="1">‚òÖ</span>
          <span class="star" data-value="2">‚òÖ</span>
          <span class="star" data-value="3">‚òÖ</span>
          <span class="star" data-value="4">‚òÖ</span>
          <span class="star" data-value="5">‚òÖ</span>
        </div>
        <p class="rating-text" id="ratingText">Tap a star to rate</p>
      </div>
<input type="hidden" id="ratingInput" value="0">
      <!-- Review Text -->
      <div class="review-text-section">
        <label for="reviewText" class="review-label">Your Review</label>
        <textarea id="reviewText" class="review-textarea" rows="5" placeholder="Share your experience with this watch... What did you like? Quality, design, comfort?"></textarea>
      </div>

      <!-- Submit Button -->
      <button id="submitReviewBtn" class="btn-review-submit" disabled>Submit Review</button>
    </div>
  </div>
</div>
</div>

<div id="modalInvoice" class="modal">
  <div class="modal-backdrop" data-close="modalInvoice"></div>
  <div class="modal-box">
    <div class="modal-header">
      <h2>Invoice</h2>
      <span class="close" data-close="modalInvoice">√ó</span>
    </div>
    <div class="modal-body text-center">
      <p>Download your invoice</p>
<a href="/profile/orders/<%= order.orderId %>/invoice" target="_blank" class="btn-confirm">View & Print Invoice</a>
    </div>
  </div>
</div>
<script>
  const ORDER_ID = "<%= order._id %>";
  const ITEM_INDEX = <%= itemIndex %>;

  function toast(message, type = "info") {
    Toastify({
      text: message,
      duration: 5000,
      gravity: "top",
      position: "right",
      backgroundColor: type === "success" ? "#16a34a" : type === "error" ? "#dc2626" : "#f59e0b",
      stopOnFocus: true,
    }).showToast();
  }

  function openModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.add('active');
  }

  function closeModal(id) {
    const modal = document.getElementById(id);
    if (modal) modal.classList.remove('active');
  }

  // Close modal when clicking backdrop or close button
  document.querySelectorAll('.modal-backdrop, [data-close]').forEach(el => {
    el.addEventListener('click', () => {
      const modalId = el.dataset.close;
      if (modalId) {
        closeModal(modalId);
      } else {
        el.closest('.modal')?.classList.remove('active');
      }
    });
  });

  document.addEventListener('DOMContentLoaded', () => {
    // Track and Invoice buttons
    document.getElementById('btnTrack')?.addEventListener('click', () => openModal('modalTrack'));
    document.getElementById('btnInvoice')?.addEventListener('click', () => openModal('modalInvoice'));

    // Cancel button - Check status before opening modal
    document.querySelectorAll('.btn-cancel').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.preventDefault();
        
        try {
          const response = await fetch(`/profile/orders/${ORDER_ID}/check-cancel?itemIndex=${ITEM_INDEX}`);
          const data = await response.json();
          
          if (data.isAlreadyCancelled) {
            toast('This item has already been cancelled', 'error');
            setTimeout(() => window.location.reload(), 2000);
            return;
          }
          
          if (!data.isCancellable) {
            toast(`Cannot cancel - Status: ${data.currentStatus}`, 'error');
            return;
          }
          
          // If still cancellable, open the modal
          openModal('modalCancel');
          
        } catch (error) {
          console.error('Error checking cancellable status:', error);
          // If API fails, just open the modal and let the actual request handle it
          openModal('modalCancel');
        }
      });
    });

    // Return button
    document.querySelectorAll('.btn-return').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        openModal('modalReturn');
      });
    });

    // Review button
    document.querySelectorAll('.btn-review').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        openModal('modalReview');
      });
    });

    // Submit Cancel
    document.getElementById('submitCancel')?.addEventListener('click', async () => {
      const submitBtn = document.getElementById('submitCancel');
      const reason = document.querySelector('input[name="cancelReason"]:checked')?.value;
      
      if (!reason) {
        return toast('Please select a cancellation reason', 'error');
      }

      // Disable button to prevent double submission
      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      try {
        const res = await axios.post(`/order/${ORDER_ID}/cancel-item`, { 
          itemIndex: ITEM_INDEX, 
          reason 
        });
        
        if (res.data.success) {
          toast('Item cancelled successfully!', 'success');
          closeModal('modalCancel');
          setTimeout(() => location.reload(), 1500);
        } else {
          // Check if message indicates already cancelled
          if (res.data.message?.toLowerCase().includes('already cancelled')) {
            toast('This item has already been cancelled', 'error');
            setTimeout(() => location.reload(), 2000);
          } else {
            toast(res.data.message || 'Failed to cancel item', 'error');
          }
        }
      } catch (err) {
        console.error('Cancel error:', err);
        
        // Handle specific error messages from backend
        const errorMsg = err.response?.data?.message || 'Something went wrong';
        
        if (errorMsg.toLowerCase().includes('already cancelled')) {
          toast('This item has already been cancelled', 'error');
          setTimeout(() => location.reload(), 2000);
        } else {
          toast(errorMsg, 'error');
        }
      } finally {
        // Re-enable button
        submitBtn.disabled = false;
        submitBtn.textContent = 'Confirm Cancellation';
      }
    });

    // Submit Return
    document.getElementById('submitReturn')?.addEventListener('click', async () => {
      const submitBtn = document.getElementById('submitReturn');
      const reason = document.querySelector('input[name="returnReason"]:checked')?.value;
      
      if (!reason) {
        return toast('Please select a return reason', 'error');
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Processing...';

      try {
        const res = await axios.post(`/order/${ORDER_ID}/return-item`, { 
          itemIndex: ITEM_INDEX, 
          reason 
        });
        
        if (res.data.success) {
          toast('Return request submitted successfully!', 'success');
          closeModal('modalReturn');
          setTimeout(() => location.reload(), 1500);
        } else {
          toast(res.data.message || 'Failed to submit return', 'error');
        }
      } catch (err) {
        console.error('Return error:', err);
        toast(err.response?.data?.message || 'Failed to submit return', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Return Request';
      }
    });

    // Review functionality
    const ratingInput = document.getElementById('ratingInput');
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    const reviewText = document.getElementById('reviewText');
    const ratingTextEl = document.getElementById('ratingText');

    // Star rating
    document.querySelectorAll('.star').forEach(star => {
      star.addEventListener('click', () => {
        const value = parseInt(star.dataset.value);

        if (ratingInput) ratingInput.value = value;

        document.querySelectorAll('.star').forEach((s, i) => {
          s.style.color = i < value ? '#fbbf24' : '#e2e8f0';
        });

        const texts = ["", "Very Bad", "Poor", "Average", "Good", "Excellent!"];
        if (ratingTextEl) ratingTextEl.textContent = texts[value];

        // Enable submit button if both rating and text are present
        if (submitReviewBtn) {
          const hasText = reviewText?.value.trim().length > 0;
          submitReviewBtn.disabled = !(value > 0 && hasText);
        }
      });
    });

    // Review text input
    if (reviewText && submitReviewBtn) {
      reviewText.addEventListener('input', () => {
        const hasText = reviewText.value.trim().length > 0;
        const hasRating = parseInt(ratingInput?.value || '0') > 0;
        submitReviewBtn.disabled = !(hasText && hasRating);
      });
    }

    // Submit Review
    if (submitReviewBtn) {
      submitReviewBtn.addEventListener('click', async () => {
        const rating = parseInt(ratingInput?.value || '0');
        const text = reviewText?.value.trim() || '';

        if (rating === 0) {
          return toast('Please rate with stars', 'error');
        }
        
        if (!text) {
          return toast('Please write your review', 'error');
        }

        submitReviewBtn.disabled = true;
        submitReviewBtn.textContent = 'Submitting...';

        try {
          const res = await axios.post(`/order/${ORDER_ID}/review-item`, {
            itemIndex: ITEM_INDEX,
            rating: rating,
            text: text
          });

          if (res.data.success) {
            toast('Review submitted successfully! üéâ', 'success');
            closeModal('modalReview');
            setTimeout(() => location.reload(), 1500);
          } else {
            toast(res.data.message || 'Failed to submit review', 'error');
          }
        } catch (err) {
          console.error('Review error:', err);
          toast(err.response?.data?.message || 'Server error', 'error');
        } finally {
          submitReviewBtn.disabled = false;
          submitReviewBtn.textContent = 'Submit Review';
        }
      });
    }

    // Handle "Other" reason input for cancel - Add text input if needed
    const cancelRadios = document.querySelectorAll('input[name="cancelReason"]');
    const otherReasonContainer = document.createElement('div');
    otherReasonContainer.style.marginTop = '10px';
    otherReasonContainer.style.display = 'none';
    
    const otherReasonInput = document.createElement('input');
    otherReasonInput.type = 'text';
    otherReasonInput.placeholder = 'Please specify your reason';
    otherReasonInput.style.width = '100%';
    otherReasonInput.style.padding = '8px';
    otherReasonInput.style.border = '1px solid #ddd';
    otherReasonInput.style.borderRadius = '4px';
    
    otherReasonContainer.appendChild(otherReasonInput);
    
    // Find where to insert the other reason input
    const radioGroup = document.querySelector('.radio-group');
    if (radioGroup) {
      radioGroup.appendChild(otherReasonContainer);
    }
    
    cancelRadios.forEach(radio => {
      radio.addEventListener('change', () => {
        if (radio.value === 'Other' && radio.checked) {
          otherReasonContainer.style.display = 'block';
        } else {
          otherReasonContainer.style.display = 'none';
        }
      });
    });
  });
</script>
</body>
</html>