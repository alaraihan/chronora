<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders | Chronora</title>
  <link rel="stylesheet" href="/css/user/profile-shared.css">
  <link rel="stylesheet" href="/css/user/orders.css">
</head>

<body>
  <%- include('../partials/user/header') %>

  <div class="profile-layout">
    <%- include('../partials/user/sidebar') %>

    <main class="profile-content">
      <header class="page-title-header">
        <h1>My Orders</h1>
        <p class="subtitle">Manage your order history here.</p>
      </header>

      <div class="orders-list" id="ordersList" style="width: 100%;">
        <% if (!pageItems || pageItems.length === 0) { %>
          <p class="empty-orders" style="text-align:center; padding:60px;">No orders yet.</p>
        <% } else { %>

          <% pageItems.forEach(({ order, item }) => { %>
            <% const orderSubtotal = order.products.reduce((sum, p) => sum + (p.price * p.quantity), 0); %>

            <div class="order-card">

              <!-- Order Header -->
              <div class="order-header-inline">
                <div class="order-meta">
                  <span class="order-date"><%= new Date(order.createdAt).toDateString() %></span>
                  <span class="order-id-small">Order #<%= order.orderId %></span>
                </div>
                <div class="item-status-badge">
                  <% if (order.paymentStatus === 'Failed') { %>
                    <span class="status-label failed">Payment Failed</span>
                  <% } else { %>
                    <span class="status-label <%= item.itemStatus.toLowerCase().replace(/\s+/g, '-') %>">
                      <%= item.itemStatus %>
                    </span>
                  <% } %>
                </div>
              </div>

              <!-- Item Main -->
              <div class="order-item-main">
                <div class="item-image-wrapper">
                  <img
                    src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>"
                    alt="<%= item.productId?.name || 'Watch' %>"
                    class="item-image"
                    onerror="this.src='/images/default-watch.jpg'"
                  >
                </div>

                <div class="item-details">
                  <h3 class="item-name"><%= item.productId?.name || 'Unknown Watch' %></h3>
                  <p class="item-variant"><%= item.variantId?.colorName || 'Standard' %></p>
                  <p class="item-quantity">Qty: <%= item.quantity %></p>
                  <p class="item-price">₹<%= (item.price * item.quantity).toLocaleString('en-IN') %></p>
                  <% if (item.reason) { %>
                    <p class="item-reason"><strong>Reason:</strong> <%= item.reason %></p>
                  <% } %>
                </div>

                <div class="item-actions">
                  <% if (item.productId && item.variantId) { %>
                    <a href="/profile/orders/<%= order.orderId %>?productId=<%= item.productId._id %>&variantId=<%= item.variantId._id %>">
                      View Details
                    </a>
                  <% } else { %>
                    <a href="/profile/orders/<%= order.orderId %>">View Order</a>
                  <% } %>
                </div>
              </div>

              <!-- Pricing Summary -->
              <div class="order-pricing-summary">
                <div class="pricing-row">
                  <span>Subtotal</span>
                  <span>₹<%= orderSubtotal.toLocaleString('en-IN') %></span>
                </div>

                <% if (order.discount > 0) { %>
                  <div class="pricing-row discount-row">
                    <span>Coupon Discount</span>
                    <span style="color:#00ff9d;">- ₹<%= order.discount.toLocaleString('en-IN') %></span>
                  </div>
                <% } %>

                <div class="price-row total-row">
                  <% if (order.paymentStatus === 'Failed' || order.paymentStatus === 'Pending') { %>
                    <span class="pr-label total-label">Order Total</span>
                    <span class="pr-value total-value">₹<%= order.totalAmount.toLocaleString('en-IN') %></span>
                    <div style="margin-top: 6px;">
                      <span style="color: #ef4444; font-size: 12px;">
                        ⚠ Payment <%= order.paymentStatus === 'Failed' ? 'failed' : 'not completed' %> — amount not charged
                      </span>
                    </div>
                  <% } else { %>
                    <span class="pr-label total-label">Amount Paid</span>
                    <span class="pr-value total-value">₹<%= order.totalAmount.toLocaleString('en-IN') %></span>
                  <% } %>
                </div>
              </div>

              <!-- Expected Delivery -->
              <% if (
                order.expectedDelivery &&
                !['Delivered', 'Cancelled', 'ReturnRequested', 'Returned', 'Failed'].includes(item.itemStatus) &&
                order.paymentStatus !== 'Failed'
              ) { %>
                <div class="delivery-info">
                  <span>Expected Delivery: <%= new Date(order.expectedDelivery).toDateString() %></span>
                </div>
              <% } %>

            </div>
          <% }) %>

        <% } %>
      </div>

      <!-- Pagination -->
      <% if (totalPages > 1) { %>
        <div class="pagination-container">

          <% if (hasPrevPage) { %>
            <a href="?page=<%= currentPage - 1 %>" class="pagination-btn">← Previous</a>
          <% } else { %>
            <span class="pagination-btn disabled">← Previous</span>
          <% } %>

          <div class="page-info">Page <%= currentPage %> of <%= totalPages %></div>

          <% if (hasNextPage) { %>
            <a href="?page=<%= currentPage + 1 %>" class="pagination-btn">Next →</a>
          <% } else { %>
            <span class="pagination-btn disabled">Next →</span>
          <% } %>

        </div>
      <% } %>

    </main>
  </div>
</body>

</html>
