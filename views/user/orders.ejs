<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Orders | Chronora</title>
  <link rel="stylesheet" href="/css/user/profile-shared.css">
  <link rel="stylesheet" href="/css/user/orders.css">
</head>

<body>
  <%- include('../partials/user/header') %>

    <div class="profile-layout">
      <%- include('../partials/user/sidebar') %>

        <main class="profile-content">
          <header class="page-title-header">
            <h1>My Orders</h1>
            <p class="subtitle">Manage your order history here.</p>
          </header>

          <div class="orders-list" id="ordersList" style="width: 100%;">
            <% if (!orders || orders.length===0) { %>
              <p class="empty-orders" style="text-align:center; padding:60px;">No orders yet.</p>
              <% } else { %>

                <% orders.forEach(order=> { %>
                  <% const orderSubtotal=order.products.reduce((sum, p)=> sum + (p.price * p.quantity), 0); %>

                    <div class="order-card">
                      <!-- Order Info Header -->
                      <div class="order-header">
                        <div class="order-id-section">
                          <span class="order-id">Order #<%= order.orderId %></span>
                          <span class="order-date">
                            <%= new Date(order.createdAt).toLocaleDateString('en-IN', { day: 'numeric' , month: 'short'
                              , year: 'numeric' }) %>
                          </span>
                        </div>
                        <div class="order-status-section">
                          <span class="status-badge status-<%= order.status.toLowerCase().replace(/\s+/g, '-') %>">
                            <%= order.status %>
                          </span>
                          <span
                            class="payment-badge payment-<%= order.paymentStatus.toLowerCase().replace(/\s+/g, '-') %>">
                            <%= order.paymentStatus %>
                          </span>
                        </div>
                      </div>

                      <!-- Order Items List -->
                      <div class="order-items">
                        <% order.products.forEach(item=> { %>
                          <div class="order-item-row">
                            <div class="item-img">
                              <img src="<%= item.variantId?.images?.[0] || '/images/default-watch.jpg' %>"
                                alt="<%= item.productId?.name || 'Watch' %>"
                                onerror="this.src='/images/default-watch.jpg'">
                            </div>
                            <div class="item-info">
                              <h4 class="product-name">
                                <%= item.productId?.name || 'Unknown Product' %>
                              </h4>
                              <p class="item-meta">
                                <span>
                                  <%= item.variantId?.colorName || 'Default' %>
                                </span> |
                                <span>Qty: <%= item.quantity %></span>
                              </p>
                              <p class="item-price">
                                <span class="unit-price">₹<%= item.price.toLocaleString('en-IN') %> per unit</span>
                                <span class="total-price">₹<%= (item.price * item.quantity).toLocaleString('en-IN') %>
                                </span>
                              </p>
                            </div>
                            <div class="item-actions">
                              <a href="/profile/orders/<%= order.orderId %>?productId=<%= item.productId?._id %>&variantId=<%= item.variantId?._id %>"
                                class="btn-detail">Details</a>
                            </div>
                          </div>
                          <% }) %>
                      </div>

                      <!-- Order Footer -->
                      <div class="order-footer">
                        <div class="order-summary-details">
                          <div class="summary-line">
                            <span>Subtotal:</span>
                            <span>₹<%= orderSubtotal.toLocaleString('en-IN') %></span>
                          </div>
                          <% if (order.discount> 0) { %>
                            <div class="summary-line discount">
                              <span>Discount:</span>
                              <span>-₹<%= order.discount.toLocaleString('en-IN') %></span>
                            </div>
                            <% } %>
                              <div class="summary-line total">
                                <span>Order Total:</span>
                                <span class="grand-total-val">₹<%= order.totalAmount.toLocaleString('en-IN') %></span>
                              </div>
                        </div>

                        <div class="order-main-actions">
                          <% if (order.paymentStatus==='Failed' || order.paymentStatus==='Pending' ) { %>
                            <button class="btn-retry"
                              onclick="retryPayment('<%= order._id %>', <%= order.totalAmount %>)">
                              <i class="retry-icon">↺</i> Retry Payment
                            </button>
                            <% } %>
                              <a href="/profile/orders/<%= order.orderId %>" class="btn-view-order">Manage Order</a>
                        </div>
                      </div>

                    </div>
                    <% }) %>

                      <% } %>
          </div>

          <!-- Pagination -->
          <% if (totalPages> 1) { %>
            <div class="pagination-container">

              <% if (hasPrevPage) { %>
                <a href="?page=<%= currentPage - 1 %>" class="pagination-btn">← Previous</a>
                <% } else { %>
                  <span class="pagination-btn disabled">← Previous</span>
                  <% } %>

                    <div class="page-info">Page <%= currentPage %> of <%= totalPages %>
                    </div>

                    <% if (hasNextPage) { %>
                      <a href="?page=<%= currentPage + 1 %>" class="pagination-btn">Next →</a>
                      <% } else { %>
                        <span class="pagination-btn disabled">Next →</span>
                        <% } %>

            </div>
            <% } %>

        </main>
    </div>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="/js/user/orders.js"></script>
</body>

</html>