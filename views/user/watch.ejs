<link rel="stylesheet" href="/css/user/watch.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
<main>
  <h1>The Watch Collection</h1>

  <div class="filters-container">
    <form class="search-form" method="GET">
      <div class="search-input-group">
        <input 
          type="text" 
          name="search" 
          placeholder="Search by name" 
          value="<%= searchQuery || '' %>"
          autocomplete="off"
        >
        <button type="submit">Search</button>
        <a href="/watch" class="clear-btn">Clear</a>
      </div>
    </form>

    <div class="controls-right">
      <form method="GET" class="control-form">
        <select name="sort" onchange="this.form.submit()">
          <option value="newest"    <%= sortQuery === 'newest' ? 'selected' : '' %>>Newest</option>
          <option value="price-low" <%= sortQuery === 'price-low' ? 'selected' : '' %>>Price: Low to High</option>
          <option value="price-high"<%= sortQuery === 'price-high' ? 'selected' : '' %>>Price: High to Low</option>
          <option value="a-z"       <%= sortQuery === 'a-z' ? 'selected' : '' %>>A to Z</option>
          <option value="z-a"       <%= sortQuery === 'z-a' ? 'selected' : '' %>>Z to A</option>
        </select>
        <% if (searchQuery) { %><input type="hidden" name="search" value="<%= searchQuery %>"><% } %>
        <% if (categoryFilter) { %><input type="hidden" name="category" value="<%= categoryFilter %>"><% } %>
      </form>

      <form method="GET" class="control-form">
        <select name="category" onchange="this.form.submit()">
          <option value="">All Categories</option>
          <% categories.forEach(cat => { %>
            <option value="<%= cat._id %>" <%= categoryFilter === cat._id.toString() ? 'selected' : '' %>>
              <%= cat.name %>
            </option>
          <% }) %>
        </select>
        <% if (searchQuery) { %><input type="hidden" name="search" value="<%= searchQuery %>"><% } %>
        <% if (sortQuery) { %><input type="hidden" name="sort" value="<%= sortQuery %>"><% } %>
      </form>
    </div>
  </div>

  <div class="watch-grid">
    <% if (products && products.length > 0) { %>
      <% products.forEach((product, index) => { %>
        <% 
          const variant = product.variant;
          const image = variant?.images?.[0] || '/images/placeholder-watch.jpg';
          const stock = variant ? variant.stock : 0;
          const variantId = variant ? variant._id : null;
        %>

        <div class="watch-card">
          <a href="/product/<%= product._id %>" class="watch-link">
            <div class="watch-image">
              <img src="<%= image %>" alt="<%= product.name %>" loading="lazy">

              <% if (product.offerData) { %>
                <span class="offer-badge">
                  <% if (product.offerData.offer.discountType === 'percentage') { %>
                    <%= product.offerData.offer.discountValue %>% OFF
                  <% } else { %>
                    ₹<%= product.offerData.offer.discountValue %> OFF
                  <% } %>
                </span>
              <% } %>

              <!-- Wishlist Heart Button -->
<button 
  class="favorite-btn <%= user && user.wishlist?.some(w => w.productId.toString() === product._id.toString() && w.variantId.toString() === variantId?.toString()) ? 'active' : '' %>"
  data-product-id="<%= product._id %>"
  data-variant-id="<%= variantId %>"
  title="<%= user && user.wishlist?.some(w => w.productId.toString() === product._id.toString() && w.variantId.toString() === variantId?.toString()) ? 'Remove from Wishlist' : 'Add to Wishlist' %>"
>
  <i class="fa-regular fa-heart" id="heart-icon"></i>  <!-- Outline by default -->
</button>
            </div>

            <div class="watch-info">
              <div class="watch-name"><%= product.name %></div>

              <div class="watch-price-container">
                <% if (product.offerData) { %>
                  <p class="watch-price-original">₹ <%= product.price.toLocaleString('en-IN') %></p>
                  <p class="watch-price-discounted">₹ <%= product.offerData.offerPrice.toLocaleString('en-IN') %></p>
                <% } else { %>
                  <p class="watch-price">₹ <%= product.price.toLocaleString('en-IN') %></p>
                <% } %>
              </div>

              <% if (variant && variant.colorName) { %>
                <div class="color-info">Color: <%= variant.colorName %></div>
              <% } %>

              <button class="add-to-cart-btn"
                      data-product-id="<%= product._id %>"
                      data-variant-id="<%= variantId %>"
                      <%= stock <= 0 ? 'disabled' : '' %>>
                <%= stock <= 0 ? 'Out of Stock' : 'View Product' %>
              </button>
            </div>
          </a>
        </div>
      <% }) %>
    <% } else { %>
      <div class="empty-state">
        <h2>No watches available</h2>
        <p>Check back later</p>
      </div>
    <% } %>
  </div>

  <!-- Pagination (unchanged) -->
  <% if (totalPages > 1) { %>
    <div class="pagination">
      <% if (currentPage > 1) { %>
        <a href="?page=<%= currentPage - 1 %>&search=<%= searchQuery %>&sort=<%= sortQuery %>&category=<%= categoryFilter %>" class="page-btn">Prev</a>
      <% } else { %>
        <span class="page-btn disabled">Prev</span>
      <% } %>

      <% for (let i = 1; i <= totalPages; i++) { %>
        <% if (i === currentPage) { %>
          <span class="page-number active"><%= i %></span>
        <% } else { %>
          <a href="?page=<%= i %>&search=<%= searchQuery %>&sort=<%= sortQuery %>&category=<%= categoryFilter %>" class="page-number"><%= i %></a>
        <% } %>
      <% } %>

      <% if (currentPage < totalPages) { %>
        <a href="?page=<%= currentPage + 1 %>&search=<%= searchQuery %>&sort=<%= sortQuery %>&category=<%= categoryFilter %>" class="page-btn">Next</a>
      <% } else { %>
        <span class="page-btn disabled">Next</span>
      <% } %>
    </div>
  <% } %>
</div>

<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
// Wishlist Heart Button Logic
document.querySelectorAll('.favorite-btn').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    e.stopPropagation(); // Prevent card click if whole card is clickable

    const productId = btn.dataset.productId;
    const variantId = btn.dataset.variantId;
    const heartIcon = btn.querySelector('i');

    if (!productId || !variantId) return;

    try {
      const res = await axios.post('/add-wishlist', { productId, variantId });

      if (res.data.success) {
        // Toggle active state
        btn.classList.toggle('active');

        // Toggle heart icon: outline ↔ filled
        if (btn.classList.contains('active')) {
          heartIcon.classList.remove('fa-regular', 'fa-heart');
          heartIcon.classList.add('fa-solid', 'fa-heart');
          toast("Added to wishlist ❤️", "success");
        } else {
          heartIcon.classList.remove('fa-solid', 'fa-heart');
          heartIcon.classList.add('fa-regular', 'fa-heart');
          toast("Removed from wishlist", "info");
        }
      } else {
        if (res.data.message?.includes("login")) {
          toast("Please login to save wishlist", "error");
          setTimeout(() => window.location.href = "/login", 1500);
        } else {
          toast(res.data.message || "Something went wrong", "error");
        }
      }
    } catch (err) {
      toast("Please login first", "error");
      setTimeout(() => window.location.href = "/login", 1000);
    }
  });
});
function toast(msg, type = "info") {
  Toastify({
    text: msg,
    duration: 3000,
    gravity: "bottom",
    position: "right",
    backgroundColor: type === "success" ? "#16a34a" : "#dc2626"
  }).showToast();
}
</script>